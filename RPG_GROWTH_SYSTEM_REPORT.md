# VitalityPact RPG成长系统升级报告

## 概览

本次升级将VitalityPact从每日状态展示应用改造为持久化RPG成长系统，实现了两大核心需求：
1. **伙伴成长系统**：持久化的等级、属性和经验值系统
2. **历史数据对话**：基于历史健康数据的智能对话

## 一、伙伴成长系统

### 1.1 数据模型 (PartnerAttributes.swift)

#### 核心属性
- **等级系统**：
  - `level`: 等级（从1开始）
  - `experience`: 当前经验值
  - `experienceToNextLevel`: 升级所需经验（等级 × 100 + 50）
  
- **四维属性**（RPG风格）：
  - `strength`: 力量（步数相关）
  - `vitality`: 体质（睡眠相关）
  - `agility`: 敏捷（运动相关）
  - `wisdom`: 智慧（综合表现）

- **统计数据**：
  - `totalPower`: 总战力（所有属性 + 等级加成）
  - `totalDaysActive`: 活跃天数
  - `createdDate`: 创建时间
  - `lastActiveDate`: 最后活跃时间

### 1.2 成长规则 (HealthRewardRule)

#### 步数奖励 → 力量
- ≥10000步: +30 EXP, +2 力量
- ≥7000步: +20 EXP, +1 力量
- ≥5000步: +10 EXP

#### 睡眠奖励 → 体质
- ≥8小时: +30 EXP, +2 体质
- ≥7小时: +20 EXP, +1 体质
- ≥6小时: +10 EXP
- <5小时: -1 体质（惩罚）

#### 运动奖励 → 敏捷
- ≥60分钟: +30 EXP, +2 敏捷
- ≥30分钟: +20 EXP, +1 敏捷
- ≥15分钟: +10 EXP

#### 综合奖励 → 智慧
- 综合评分≥80: +20 EXP, +2 智慧
- 综合评分≥60: +1 智慧

### 1.3 升级机制

- **自动升级**：经验值达到要求时自动升级
- **属性增长**：升级时随机增加属性（1-3点）
- **等级上限**：理论无限制
- **经验递增**：等级越高升级越难

### 1.4 独立性设计

- **每个伙伴独立**：属性保存使用 `partnerId` 作为唯一标识
- **切换不丢失**：切换伙伴时各自的属性独立保存
- **多伙伴培养**：鼓励用户培养多个伙伴

## 二、历史数据系统

### 2.1 数据存储 (HealthHistory.swift)

#### 每日记录 (DailyHealthRecord)
- 日期、步数、睡眠时长、运动时长、综合评分
- 最多保留90天记录
- 自动去重（同一天只保留最新记录）

### 2.2 历史分析 (HealthHistoryAnalysis)

#### 统计数据
- 平均步数、平均睡眠、平均运动、平均评分
- 最近N天的统计（默认7天）

#### 趋势分析
- **睡眠趋势**：改善中/稳定/下降中/数据不足
- **步数趋势**：改善中/稳定/下降中/数据不足
- **运动趋势**：改善中/稳定/下降中/数据不足

#### 异常检测
- 连续睡眠不足天数（<6小时）
- 连续步数不足天数（<5000步）

### 2.3 分析文本生成

自动生成结构化摘要供LLM使用：
```
近7天健康数据：
睡眠：平均6.5小时/天，已连续3天睡眠不足（<6小时），趋势📉有所下降。
步数：平均7200步/天，趋势➡️保持稳定。
运动：平均25分钟/天，趋势📈正在改善。
综合健康评分：62/100
```

## 三、AI对话升级

### 3.1 历史数据集成

#### generateDialogue() 增强
- 添加 `historyAnalysis` 参数
- 分析最近7天数据
- prompt包含历史趋势和具体数据

#### chat() 增强
- 聊天对话也支持历史数据
- 用户询问健康问题时结合历史回答

### 3.2 对话特点

- **具体数据**：明确指出"连续3天睡眠不足"
- **趋势分析**：说明是改善还是下降
- **个性化建议**：基于历史和趋势给建议
- **保持风格**：不同伙伴保持各自对话风格

## 四、UI展示

### 4.1 迷你属性面板 (PartnerStatsMini)

显示在主界面顶部，包含：
- 等级和战力
- 经验进度条
- 点击进入完整属性面板

### 4.2 完整属性面板 (PartnerStatsView)

完整展示：
- 伙伴名称和战力
- 等级和经验条
- 四维属性详情（带图标和描述）
- 统计信息（活跃天数、创建时间等）

### 4.3 升级动画 (LevelUpAnimationView)

- 金色星星旋转动画
- 等级变化展示（LV.1 → LV.2）
- 震动反馈
- 3秒后自动关闭

## 五、持久化存储

### 5.1 伙伴属性存储
- 使用 `UserDefaults` + JSON编码
- Key: `partnerAttributesDict`
- 格式: `[String: PartnerAttributes]`（partnerId → 属性）

### 5.2 历史数据存储
- 使用 `UserDefaults` + JSON编码
- Key: `healthHistoryRecords`
- 格式: `[DailyHealthRecord]`
- 自动清理90天前的旧记录

## 六、调试功能

### 6.1 DebugPanelView新增功能

#### 伙伴成长系统管理
- 查看当前伙伴属性
- 手动触发今日奖励计算
- 重置所有伙伴属性

#### 历史数据管理
- 查看最近记录
- 查看历史分析结果
- 清空所有历史记录

## 七、关键文件

### 新增文件
1. `/Models/PartnerAttributes.swift` - 伙伴属性系统
2. `/Models/HealthHistory.swift` - 历史数据系统
3. `/Views/PartnerStatsView.swift` - 属性展示UI

### 修改文件
1. `GameStateManager.swift` - 集成成长和历史系统
2. `AIService.swift` - 支持历史数据对话
3. `ChatView.swift` - 聊天支持历史数据
4. `ContentView.swift` - 添加属性展示和升级动画
5. `DebugPanelView.swift` - 添加管理功能

## 八、使用流程

### 8.1 每日流程
1. 用户打开应用
2. 系统自动获取今日健康数据
3. 检查是否是新的一天
4. 如果是新的一天：
   - 记录昨日健康数据到历史
   - 计算昨日奖励
   - 应用奖励到当前伙伴
   - 检查是否升级
   - 显示升级动画（如果升级）
5. 生成对话（包含历史分析）

### 8.2 切换伙伴
1. 用户切换伙伴
2. 系统加载该伙伴的独立属性
3. 伙伴A的属性保留，不影响伙伴B

### 8.3 查看属性
1. 点击主界面顶部属性面板
2. 查看完整属性信息
3. 了解成长情况

## 九、设计亮点

### 9.1 用户粘性提升
- **长期目标**：培养伙伴等级和属性
- **持久化进度**：不会每天重置
- **多伙伴培养**：增加游戏深度
- **成就感**：升级和属性提升

### 9.2 对话质量提升
- **数据具体化**：不再只说"健康"或"不健康"
- **历史关联**：指出连续异常情况
- **趋势感知**：了解改善或下降
- **个性化**：基于用户实际历史

### 9.3 技术优势
- **独立存储**：伙伴互不影响
- **自动管理**：历史数据自动记录和清理
- **性能优化**：只保留90天数据
- **可扩展**：易于添加新属性或规则

## 十、测试建议

### 10.1 功能测试
- [ ] 新用户首次运行，创建伙伴
- [ ] 连续多天使用，验证经验积累
- [ ] 升级触发，查看动画和属性变化
- [ ] 切换伙伴，验证属性独立性
- [ ] 查看历史分析，验证趋势判断
- [ ] 对话生成，验证历史数据引用

### 10.2 极限测试
- [ ] 连续30天满分数据，验证高等级表现
- [ ] 连续低分数据，验证惩罚机制
- [ ] 切换多个伙伴，验证性能
- [ ] 90天后，验证历史数据自动清理

### 10.3 调试测试
- [ ] 使用调试面板手动触发奖励
- [ ] 重置伙伴属性
- [ ] 清空历史记录
- [ ] 查看历史分析输出

## 十一、未来扩展方向

### 11.1 可能的新功能
- 伙伴技能系统
- 属性点自由分配
- 伙伴进化/转职
- 成就系统
- 排行榜（匿名）

### 11.2 数据扩展
- 更多健康指标（心率、血氧等）
- 长期目标设定
- 周/月报告
- 数据可视化图表

### 11.3 社交功能
- 好友伙伴对比
- 健康挑战
- 共同目标

## 十二、注意事项

1. **首次运行**：历史数据为空，对话不会引用历史
2. **数据记录**：每天只记录一次，重复运行会更新当天记录
3. **经验计算**：基于健康数据，作弊会获得不合理的高属性
4. **存储限制**：UserDefaults适合小数据量，未来可考虑CoreData
5. **时区问题**：使用本地时区，跨时区可能有问题

## 总结

本次升级成功将VitalityPact从简单的健康状态展示应用升级为具有深度的RPG成长系统。通过持久化的伙伴属性和基于历史数据的智能对话，大幅提升了用户粘性和应用趣味性。系统设计考虑了扩展性和性能，为未来功能迭代打下良好基础。
