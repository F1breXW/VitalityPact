# VitalityPactï¼ˆæ´»åŠ›å¥‘çº¦ï¼‰é¡¹ç›®è¯¦ç»†æ–‡æ¡£

> ç§»åŠ¨åº”ç”¨å¼€å‘è¯¾ç¨‹ç­”è¾©æ–‡æ¡£
> 
> ä½œè€…ï¼šHenry King  
> æ—¥æœŸï¼š2025å¹´12æœˆ27æ—¥  
> è¯¾ç¨‹é‡ç‚¹ï¼šMVVMæ¶æ„æ¨¡å¼

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [MVVMæ¶æ„è¯¦è§£](#2-mvvmæ¶æ„è¯¦è§£)
3. [æ ¸å¿ƒæŠ€æœ¯æ ˆ](#3-æ ¸å¿ƒæŠ€æœ¯æ ˆ)
4. [é¡¹ç›®ç»“æ„åˆ†æ](#4-é¡¹ç›®ç»“æ„åˆ†æ)
5. [æ•°æ®æ¨¡å‹å±‚ï¼ˆModelï¼‰è¯¦è§£](#5-æ•°æ®æ¨¡å‹å±‚modelè¯¦è§£)
6. [è§†å›¾å±‚ï¼ˆViewï¼‰è¯¦è§£](#6-è§†å›¾å±‚viewè¯¦è§£)
7. [è§†å›¾æ¨¡å‹å±‚ï¼ˆViewModelï¼‰è¯¦è§£](#7-è§†å›¾æ¨¡å‹å±‚viewmodelè¯¦è§£)
8. [æœåŠ¡å±‚æ¶æ„](#8-æœåŠ¡å±‚æ¶æ„)
9. [æ•°æ®æµä¸çŠ¶æ€ç®¡ç†](#9-æ•°æ®æµä¸çŠ¶æ€ç®¡ç†)
10. [æ ¸å¿ƒåŠŸèƒ½å®ç°](#10-æ ¸å¿ƒåŠŸèƒ½å®ç°)
11. [è®¾è®¡æ¨¡å¼åº”ç”¨](#11-è®¾è®¡æ¨¡å¼åº”ç”¨)
12. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#12-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
13. [é¡¹ç›®åˆ›æ–°ç‚¹](#13-é¡¹ç›®åˆ›æ–°ç‚¹)
14. [å¼€å‘è¿‡ç¨‹ä¸æŒ‘æˆ˜](#14-å¼€å‘è¿‡ç¨‹ä¸æŒ‘æˆ˜)
15. [æµ‹è¯•ä¸è°ƒè¯•](#15-æµ‹è¯•ä¸è°ƒè¯•)
16. [æ€»ç»“ä¸å±•æœ›](#16-æ€»ç»“ä¸å±•æœ›)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

éšç€ç°ä»£ç”Ÿæ´»èŠ‚å¥çš„åŠ å¿«ï¼Œäººä»¬çš„å¥åº·ç®¡ç†æ„è¯†é€æ¸å¢å¼ºï¼Œä½†ä¼ ç»Ÿçš„å¥åº·ç®¡ç†åº”ç”¨å¾€å¾€è¿‡äºä¸¥è‚ƒå’Œæ¯ç‡¥ï¼Œç”¨æˆ·ç²˜æ€§ä¸è¶³ã€‚VitalityPactï¼ˆæ´»åŠ›å¥‘çº¦ï¼‰é¡¹ç›®æ—¨åœ¨é€šè¿‡**æ¸¸æˆåŒ–è®¾è®¡**å’Œ**æƒ…æ„ŸåŒ–äº¤äº’**ï¼Œå°†å¥åº·ç®¡ç†å˜æˆä¸€ç§æœ‰è¶£çš„ä½“éªŒï¼Œè®©ç”¨æˆ·åœ¨ä¸è™šæ‹Ÿä¼™ä¼´çš„äº’åŠ¨ä¸­è‡ªç„¶è€Œç„¶åœ°å…»æˆå¥åº·ä¹ æƒ¯ã€‚

### 1.2 é¡¹ç›®å®šä½

**VitalityPact** æ˜¯ä¸€æ¬¾åŸºäºiOSå¹³å°çš„å¥åº·ç®¡ç†åº”ç”¨ï¼Œæ ¸å¿ƒç‰¹è‰²æ˜¯ï¼š

- ğŸ® **è™šæ‹Ÿä¼™ä¼´é™ªä¼´ç³»ç»Ÿ**ï¼šç”¨æˆ·é€‰æ‹©è™šæ‹Ÿè§’è‰²ä½œä¸ºå¥åº·ä¼™ä¼´
- ğŸ¤– **AIé©±åŠ¨çš„ä¸ªæ€§åŒ–å¯¹è¯**ï¼šåŸºäºå¤§è¯­è¨€æ¨¡å‹çš„æ™ºèƒ½äº¤äº’
- ğŸ“Š **å®Œæ•´çš„å¥åº·æ•°æ®è¿½è¸ª**ï¼šæ·±åº¦é›†æˆApple HealthKit
- ğŸª™ **æ¸¸æˆåŒ–æ¿€åŠ±æœºåˆ¶**ï¼šé€šè¿‡é‡‘å¸ç³»ç»Ÿæ¿€åŠ±å¥åº·è¡Œä¸º
- ğŸ“ˆ **RPGæˆé•¿ç³»ç»Ÿ**ï¼šä¼™ä¼´éšç”¨æˆ·å¥åº·çŠ¶æ€æˆé•¿

### 1.3 ç›®æ ‡ç”¨æˆ·

- **å¹´è½»ä¸Šç­æ—**ï¼šéœ€è¦å¥åº·æé†’å’Œç›‘ç£
- **å¥èº«çˆ±å¥½è€…**ï¼šéœ€è¦æ•°æ®è¿½è¸ªå’Œåˆ†æ
- **æ¸¸æˆç©å®¶**ï¼šå–œæ¬¢æ¸¸æˆåŒ–çš„ä½“éªŒ
- **å…³æ³¨å¥åº·çš„ä¸­è€å¹´äºº**ï¼šéœ€è¦ç®€å•æ˜“ç”¨çš„å¥åº·ç®¡ç†å·¥å…·

### 1.4 æ ¸å¿ƒä»·å€¼

1. **æƒ…æ„Ÿé™ªä¼´**ï¼šè™šæ‹Ÿä¼™ä¼´æä¾›æƒ…æ„Ÿæ”¯æŒï¼Œä¸å†å­¤å•
2. **æ•°æ®é©±åŠ¨**ï¼šçœŸå®å¥åº·æ•°æ®é©±åŠ¨åº”ç”¨é€»è¾‘
3. **å³æ—¶åé¦ˆ**ï¼šå®æ—¶å“åº”å¥åº·çŠ¶æ€å˜åŒ–
4. **æŒç»­æ¿€åŠ±**ï¼šé‡‘å¸å’Œæˆé•¿ç³»ç»Ÿæä¾›é•¿æœŸåŠ¨åŠ›

### 1.5 æŠ€æœ¯è¦æ±‚

- **å¹³å°**ï¼šiOS 17.0+
- **å¼€å‘è¯­è¨€**ï¼šSwift 5.9
- **UIæ¡†æ¶**ï¼šSwiftUI
- **æ¶æ„æ¨¡å¼**ï¼šMVVMï¼ˆModel-View-ViewModelï¼‰
- **æ•°æ®æŒä¹…åŒ–**ï¼šUserDefaultsã€HealthKit
- **ç½‘ç»œé€šä¿¡**ï¼šURLSession + RESTful API

---

## 2. MVVMæ¶æ„è¯¦è§£

### 2.1 ä¸ºä»€ä¹ˆé€‰æ‹©MVVMï¼Ÿ

åœ¨ç§»åŠ¨åº”ç”¨å¼€å‘ä¸­ï¼Œæ¶æ„æ¨¡å¼çš„é€‰æ‹©è‡³å…³é‡è¦ã€‚æœ¬é¡¹ç›®é€‰æ‹©MVVMï¼ˆModel-View-ViewModelï¼‰æ¶æ„çš„åŸå› ï¼š

#### 2.1.1 ä¸MVCçš„å¯¹æ¯”

**ä¼ ç»ŸMVCçš„é—®é¢˜**ï¼šåœ¨ä¼ ç»Ÿçš„MVCæ¶æ„ä¸­ï¼ŒControllerå±‚å¾€å¾€æ‰¿æ‹…äº†è¿‡å¤šçš„è´£ä»»ï¼Œå¯¼è‡´ä»£ç è‡ƒè‚¿ã€éš¾ä»¥ç»´æŠ¤ï¼Œè¿™è¢«ç§°ä¸º"Massive View Controller"é—®é¢˜ã€‚åŒæ—¶ï¼ŒViewå’ŒModelä¹‹é—´å¯èƒ½å­˜åœ¨ç›´æ¥è€¦åˆï¼Œä½¿å¾—ç»„ä»¶éš¾ä»¥å¤ç”¨ã€‚æ•°æ®æµå‘ä¹Ÿä¸å¤Ÿæ¸…æ™°ï¼Œå¯¼è‡´çŠ¶æ€ç®¡ç†å˜å¾—å¤æ‚ã€‚

**MVVMçš„ä¼˜åŠ¿**ï¼šMVVMæ¶æ„é€šè¿‡å¼•å…¥ViewModelå±‚ï¼Œå®ç°äº†æ›´æ¸…æ™°çš„èŒè´£åˆ†ç¦»ã€‚Modelä¸“æ³¨äºçº¯æ•°æ®å®šä¹‰ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼›Viewä¸“æ³¨äºUIå±•ç¤ºå’Œç”¨æˆ·äº¤äº’ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼›ViewModelåˆ™ä½œä¸ºä¸­é—´å±‚ï¼Œå¤„ç†æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®è½¬æ¢ã€‚è¿™ç§è®¾è®¡ä½¿å¾—æ¯ä¸€å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£ï¼Œä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚SwiftUIçš„@Publishedå’Œ@ObservedObjectå¤©ç„¶æ”¯æŒåŒå‘æ•°æ®ç»‘å®šï¼Œå½“æ•°æ®å˜åŒ–æ—¶ï¼ŒUIä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå¤§å¤§ç®€åŒ–äº†å¼€å‘è¿‡ç¨‹ã€‚æ­¤å¤–ï¼ŒViewModelå¯ä»¥ç‹¬ç«‹äºUIè¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œæé«˜äº†ä»£ç çš„å¯æµ‹è¯•æ€§å’Œå¤ç”¨æ€§ã€‚

### 2.2 MVVMä¸‰å±‚æ¶æ„

æœ¬é¡¹ç›®çš„MVVMæ¶æ„ç”±ä¸‰ä¸ªå±‚æ¬¡æ„æˆï¼Œå½¢æˆæ¸…æ™°çš„å•å‘æ•°æ®æµå’ŒèŒè´£åˆ†ç¦»ï¼š

**Viewå±‚ï¼ˆè§†å›¾å±‚ï¼‰**åŒ…å«æ‰€æœ‰çš„ç”¨æˆ·ç•Œé¢ç»„ä»¶ï¼Œå¦‚ContentViewä¸»ç•Œé¢ã€ChatViewèŠå¤©ç•Œé¢ã€HealthHistoryViewå¥åº·å†å²ç•Œé¢ç­‰ã€‚Viewå±‚çš„èŒè´£æ˜¯çº¯ç²¹çš„UIå±•ç¤ºã€å“åº”ç”¨æˆ·äº¤äº’ï¼Œå¹¶é€šè¿‡@ObservedObjectæˆ–@EnvironmentObjectç»‘å®šViewModelçš„æ•°æ®ã€‚Viewå±‚ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œæ‰€æœ‰ç”¨æˆ·æ“ä½œéƒ½å§”æ‰˜ç»™ViewModelå¤„ç†ã€‚

**ViewModelå±‚ï¼ˆè§†å›¾æ¨¡å‹å±‚ï¼‰**æ˜¯æ¶æ„çš„æ ¸å¿ƒï¼Œä¸»è¦åŒ…æ‹¬GameStateManageræ¸¸æˆçŠ¶æ€ç®¡ç†å™¨å’ŒHealthStoreManagerå¥åº·æ•°æ®ç®¡ç†å™¨ã€‚ViewModelå±‚è´Ÿè´£æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ŒåŒ…æ‹¬æ•°æ®éªŒè¯ã€æ ¼å¼è½¬æ¢ã€çŠ¶æ€ç®¡ç†ç­‰ã€‚å®ƒè°ƒç”¨Serviceå±‚è·å–æ•°æ®ï¼Œå°†è·å–çš„åŸå§‹æ•°æ®è½¬æ¢æˆViewå¯ä»¥ç›´æ¥ä½¿ç”¨çš„æ ¼å¼ï¼Œå¹¶é€šè¿‡@Publishedå±æ€§è‡ªåŠ¨é€šçŸ¥Viewæ›´æ–°ã€‚

**Modelå±‚ï¼ˆæ¨¡å‹å±‚ï¼‰**å®šä¹‰åº”ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬HealthDataå¥åº·æ•°æ®ã€HealthHistoryå†å²è®°å½•ã€CharacterTypeè§’è‰²ç±»å‹ç­‰ã€‚Modelå±‚åªå…³æ³¨æ•°æ®çš„å®šä¹‰ã€éªŒè¯è§„åˆ™å’Œè®¡ç®—å±æ€§ï¼Œä¸åŒ…å«ä»»ä½•UIç›¸å…³çš„ä»£ç ï¼Œä¹Ÿä¸ä¾èµ–äºä¸šåŠ¡é€»è¾‘ã€‚è¿™ç§çº¯ç²¹æ€§ä½¿å¾—Modelå¯ä»¥åœ¨é¡¹ç›®çš„ä»»ä½•åœ°æ–¹å¤ç”¨ï¼Œä¹Ÿä¾¿äºè¿›è¡Œå•å…ƒæµ‹è¯•ã€‚

ä¸‰å±‚ä¹‹é—´é€šè¿‡æ˜ç¡®çš„æ¥å£è¿›è¡Œäº¤äº’ï¼šViewé€šè¿‡æ•°æ®ç»‘å®šè§‚å¯ŸViewModelï¼ŒViewModelæ“ä½œModelæ•°æ®å¹¶å‘å¸ƒå˜åŒ–ï¼Œå½¢æˆäº†æ¸…æ™°çš„å•å‘æ•°æ®æµã€‚

### 2.3 æœ¬é¡¹ç›®çš„MVVMå®ç°

### 2.3 æœ¬é¡¹ç›®çš„MVVMå®ç°

#### 2.3.1 Modelå±‚ï¼ˆæ•°æ®æ¨¡å‹ï¼‰

æœ¬é¡¹ç›®çš„Modelå±‚é‡‡ç”¨çº¯ç²¹çš„æ•°æ®é©±åŠ¨è®¾è®¡ï¼Œæ‰€æœ‰æ¨¡å‹éƒ½éµå¾ªCodableåè®®ä»¥æ”¯æŒæ•°æ®æŒä¹…åŒ–ï¼Œä½¿ç”¨ç»“æ„ä½“ï¼ˆstructï¼‰ä½œä¸ºå€¼ç±»å‹ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚

**HealthDataå¥åº·æ•°æ®æ¨¡å‹**æ˜¯æ•´ä¸ªåº”ç”¨çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œè´Ÿè´£å®šä¹‰å¥åº·æ•°æ®ï¼ˆæ­¥æ•°ã€ç¡çœ æ—¶é•¿ã€è¿åŠ¨åˆ†é’Ÿæ•°ã€å¿ƒç‡ã€é‡‘å¸æ•°é‡ï¼‰åŠå…¶ç›¸å…³çš„è®¡ç®—é€»è¾‘ã€‚è¯¥æ¨¡å‹é€šè¿‡è®¡ç®—å±æ€§å®ç°äº†è¯„åˆ†ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ­¥æ•°è¯„åˆ†ã€ç¡çœ è¯„åˆ†ã€è¿åŠ¨è¯„åˆ†ï¼Œä»¥åŠåŠ æƒè®¡ç®—çš„ç»¼åˆå¥åº·åˆ†æ•°ã€‚é‡‘å¸æ›´æ–°é€»è¾‘ä¹Ÿå°è£…åœ¨æ¨¡å‹å†…éƒ¨ï¼Œé€šè¿‡æ—¥æœŸåˆ¤æ–­é¿å…é‡å¤è®¡ç®—ã€‚è¿™ä¸ªæ¨¡å‹çš„è®¾è®¡äº®ç‚¹åœ¨äºä½¿ç”¨è®¡ç®—å±æ€§å°è£…å¤æ‚é€»è¾‘ï¼Œä¿æŒæ•°æ®å±‚çš„çº¯ç²¹æ€§ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨ä¸šåŠ¡é€»è¾‘ã€‚

**HealthHistoryå¥åº·å†å²æ¨¡å‹**ç®¡ç†ç”¨æˆ·çš„å†å²å¥åº·è®°å½•ï¼Œé‡‡ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€æ•°æ®ä¸€è‡´æ€§ã€‚å®ƒç»´æŠ¤ä¸€ä¸ªDailyHealthRecordæ•°ç»„ï¼Œæœ€å¤šä¿å­˜90å¤©çš„æ•°æ®ä»¥æ§åˆ¶å†…å­˜å ç”¨ã€‚è¯¥æ¨¡å‹æä¾›è¶‹åŠ¿åˆ†æåŠŸèƒ½ï¼Œå¯ä»¥è®¡ç®—å¹³å‡å€¼ã€æ£€æµ‹å¼‚å¸¸ã€è¯†åˆ«å¥åº·è¶‹åŠ¿ï¼ˆä¸Šå‡ã€ä¸‹é™ã€ç¨³å®šï¼‰ã€‚é€šè¿‡Codableåè®®å’ŒJSONç¼–ç ï¼Œå†å²æ•°æ®è¢«æŒä¹…åŒ–åˆ°UserDefaultsï¼Œç¡®ä¿åº”ç”¨é‡å¯åæ•°æ®ä¸ä¸¢å¤±ã€‚

**CharacterTypeè§’è‰²ç±»å‹æ¨¡å‹**ä½¿ç”¨æšä¸¾å®šä¹‰äº†å››ç§åŸºç¡€è§’è‰²ï¼šæˆ˜å£«ã€æ³•å¸ˆã€å® ç‰©ã€æ™ºè€…ã€‚æ¯ç§è§’è‰²éƒ½æœ‰ç‹¬ç‰¹çš„å±æ€§ï¼ŒåŒ…æ‹¬å›¾æ ‡ã€ä¸»é¢˜è‰²å’Œå¯¹è¯é£æ ¼ã€‚è¯¥æ¨¡å‹è¿˜å®ç°äº†çŠ¶æ€è¡¨æƒ…æ˜ å°„ç³»ç»Ÿï¼Œæ ¹æ®ç”¨æˆ·çš„å¥åº·ç­‰çº§ï¼ˆå±é™©ã€è™šå¼±ã€æ­£å¸¸ã€è‰¯å¥½ã€ä¼˜ç§€ï¼‰åŠ¨æ€æ˜¾ç¤ºä¸åŒçš„è¡¨æƒ…ç¬¦å·å’Œè§†è§‰ç‰¹æ•ˆã€‚æšä¸¾ç±»å‹çš„ä½¿ç”¨ç¡®ä¿äº†ç±»å‹å®‰å…¨ï¼Œé¿å…äº†è¿è¡Œæ—¶é”™è¯¯ã€‚

**ImageCharacterå›¾ç‰‡è§’è‰²æ¨¡å‹**æ‰©å±•äº†è§’è‰²ç³»ç»Ÿï¼Œæ”¯æŒ6ä¸ªä»¥ä¸Šçš„å¯è§£é”è§’è‰²ï¼Œæ¯ä¸ªè§’è‰²éƒ½æœ‰ç‹¬ç‰¹çš„å›¾ç‰‡èµ„æºã€ä¸»é¢˜è‰²å’Œè§£é”æˆæœ¬ï¼ˆ500-1500é‡‘å¸ï¼‰ã€‚è¯¥æ¨¡å‹æ”¯æŒå¤šç§è§†è§‰é£æ ¼åˆ†ç±»ï¼ˆåŠ¨æ¼«ã€Qç‰ˆã€åƒç´ ã€å†™å®ï¼‰ï¼Œå¹¶é€šè¿‡å­—å…¸æ˜ å°„å¥åº·ç­‰çº§åˆ°å¯¹åº”çš„å›¾ç‰‡èµ„æºã€‚è§£é”çŠ¶æ€é€šè¿‡Seté›†åˆç®¡ç†ï¼Œæä¾›O(1)çš„æŸ¥è¯¢æ•ˆç‡ã€‚

**PartnerAttributesä¼™ä¼´å±æ€§æ¨¡å‹**å®ç°äº†RPGé£æ ¼çš„è§’è‰²æˆé•¿ç³»ç»Ÿï¼ŒåŒ…å«ç­‰çº§ã€ç»éªŒå€¼å’Œå››ç»´å±æ€§ï¼ˆåŠ›é‡ã€ä½“åŠ›ã€æ•æ·ã€æ™ºæ…§ï¼‰ã€‚è¯¥æ¨¡å‹å°è£…äº†å‡çº§è®¡ç®—é€»è¾‘ï¼Œå½“ç»éªŒå€¼è¾¾åˆ°é˜ˆå€¼æ—¶è‡ªåŠ¨æå‡ç­‰çº§å¹¶å¢åŠ å±æ€§ç‚¹ã€‚è¿™ç§è®¾è®¡ä¸ºæœªæ¥æ‰©å±•æ›´å¤šæ¸¸æˆåŒ–åŠŸèƒ½é¢„ç•™äº†ç©ºé—´ã€‚

#### 2.3.2 ViewModelå±‚ï¼ˆè§†å›¾æ¨¡å‹ï¼‰

ViewModelå±‚ä½¿ç”¨classç±»å‹å®ç°ï¼Œç»§æ‰¿è‡ªObservableObjectåè®®ï¼Œé€šè¿‡@Publishedå±æ€§åŒ…è£…å™¨å®ç°å“åº”å¼æ•°æ®ç»‘å®šã€‚

**GameStateManageræ¸¸æˆçŠ¶æ€ç®¡ç†å™¨**æ˜¯åº”ç”¨çš„æ ¸å¿ƒViewModelï¼Œè´Ÿè´£ç®¡ç†å…¨å±€æ¸¸æˆçŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘ã€‚å®ƒç»´æŠ¤ä¼™ä¼´å±æ€§ã€å¥åº·å†å²ã€åŠ¨ç”»çŠ¶æ€ï¼ˆå®ç®±åŠ¨ç”»ã€å‡çº§åŠ¨ç”»ï¼‰ç­‰å¤šä¸ª@Publishedå±æ€§ã€‚å½“HealthStoreManageræä¾›æ–°çš„å¥åº·æ•°æ®æ—¶ï¼ŒGameStateManagerè´Ÿè´£æ›´æ–°ä¼™ä¼´çŠ¶æ€ã€è®°å½•å†å²æ•°æ®ã€è®¡ç®—é‡‘å¸å¥–åŠ±ã€æ£€æŸ¥æˆå°±è¾¾æˆæƒ…å†µã€‚å®ƒè¿˜è´Ÿè´£åè°ƒAIServiceç”Ÿæˆä¸ªæ€§åŒ–å¯¹è¯ï¼Œæ ¹æ®ç”¨æˆ·çš„å¥åº·çŠ¶æ€å’Œè§’è‰²ç±»å‹è°ƒæ•´å¯¹è¯å†…å®¹ã€‚è¯¥ç®¡ç†å™¨é‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿åº”ç”¨å†…çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚

**HealthStoreManagerå¥åº·æ•°æ®ç®¡ç†å™¨**ä¸“é—¨è´Ÿè´£ä¸iOSçš„HealthKitæ¡†æ¶äº¤äº’ï¼Œå¤„ç†æ‰€æœ‰å¥åº·æ•°æ®çš„è·å–å’Œæ›´æ–°ã€‚å®ƒå°è£…äº†æƒé™è¯·æ±‚æµç¨‹ã€æ•°æ®æŸ¥è¯¢é€»è¾‘å’Œå®æ—¶ç›‘å¬æœºåˆ¶ã€‚è¯¥ç®¡ç†å™¨é€šè¿‡async/awaitå¼‚æ­¥æ¨¡å¼å¹¶å‘æŸ¥è¯¢å¤šç§å¥åº·æ•°æ®ï¼ˆæ­¥æ•°ã€ç¡çœ ã€è¿åŠ¨ã€å¿ƒç‡ï¼‰ï¼Œæ˜¾è‘—æå‡äº†æ•°æ®è·å–æ•ˆç‡ã€‚æŸ¥è¯¢ç»“æœè¢«è½¬æ¢æˆHealthDataæ¨¡å‹å¹¶é€šè¿‡@Publishedå±æ€§å‘å¸ƒï¼Œè§¦å‘ç›¸å…³Viewçš„è‡ªåŠ¨æ›´æ–°ã€‚å®ƒè¿˜å®ç°äº†åå°æ•°æ®ç›‘å¬ï¼Œå½“ç”¨æˆ·å¥åº·æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆå¦‚æ­¥æ•°å¢åŠ ï¼‰åŠæ—¶æ›´æ–°ç•Œé¢ã€‚

ä¸¤ä¸ªViewModelä¹‹é—´é€šè¿‡æ˜ç¡®çš„æ¥å£åä½œï¼šHealthStoreManagerä¸“æ³¨äºæ•°æ®è·å–ï¼ŒGameStateManagerä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚è¿™ç§åˆ†å·¥ä½¿å¾—ä»£ç èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæµ‹è¯•ã€‚
2. è§’è‰²å¯¹è¯ç”Ÿæˆå’Œç®¡ç†
3. ä¼™ä¼´å±æ€§ç®¡ç†
4. åŠ¨ç”»çŠ¶æ€æ§åˆ¶
5. å¥åº·æ•°æ®å˜åŒ–å“åº”

å…³é”®å±æ€§ï¼š
@Published var dialogue: String              // å½“å‰å¯¹è¯å†…å®¹
@Published var isLoadingDialogue: Bool       // å¯¹è¯åŠ è½½çŠ¶æ€
@Published var showChestAnimation: Bool      // å®ç®±åŠ¨ç”»
@Published var showLevelUpAnimation: Bool    // å‡çº§åŠ¨ç”»
let healthHistory: HealthHistoryManager      // å†å²è®°å½•ç®¡ç†å™¨

å…³é”®æ–¹æ³•ï¼š
- generateDialogue(for:)     // ç”Ÿæˆè§’è‰²å¯¹è¯
- updateGameState(from:)     // æ›´æ–°æ¸¸æˆçŠ¶æ€
- addExperience(_:)          // å¢åŠ ç»éªŒå€¼
- showReward()               // æ˜¾ç¤ºå¥–åŠ±

MVVMä½“ç°ï¼š
âœ“ ä½œä¸ºä¸­é—´å±‚è¿æ¥Viewå’ŒModel
âœ“ å¤„ç†æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
âœ“ é€šè¿‡@Publishedè‡ªåŠ¨é€šçŸ¥Viewæ›´æ–°
âœ“ ä¸åŒ…å«ä»»ä½•UIä»£ç 
```

**2. HealthStoreManagerï¼ˆå¥åº·æ•°æ®ç®¡ç†å™¨ï¼‰**
```swift
ä½ç½®ï¼šVitalityPact/Services/HealthStoreManager.swift

ç±»å‹ï¼šclassï¼ˆå¼•ç”¨ç±»å‹ï¼‰
ç»§æ‰¿ï¼šObservableObject

æ ¸å¿ƒèŒè´£ï¼š
1. HealthKitæ•°æ®è·å–å’Œç®¡ç†
2. å¥åº·æ•°æ®çŠ¶æ€ç®¡ç†
3. è°ƒè¯•æ¨¡å¼æ•°æ®æ¨¡æ‹Ÿ
4. æˆæƒçŠ¶æ€ç®¡ç†
5. æ•°æ®æ›´æ–°å’Œé€šçŸ¥

å…³é”®å±æ€§ï¼š
@Published var healthData: HealthData        // å½“å‰å¥åº·æ•°æ®
@Published var isLoading: Bool               // åŠ è½½çŠ¶æ€
@Published var isAuthorized: Bool            // æˆæƒçŠ¶æ€
@Published var debugMode: Bool               // è°ƒè¯•æ¨¡å¼
@Published var debugSteps: Double            // è°ƒè¯•æ­¥æ•°
@Published var debugSleepHours: Double       // è°ƒè¯•ç¡çœ 
@Published var debugExerciseMinutes: Double  // è°ƒè¯•è¿åŠ¨

å…³é”®æ–¹æ³•ï¼š
- requestAuthorization()     // è¯·æ±‚HealthKitæˆæƒ
- fetchAllData()             // è·å–æ‰€æœ‰å¥åº·æ•°æ®
- fetchSteps()               // è·å–æ­¥æ•°
- fetchSleepHours()          // è·å–ç¡çœ 
- fetchExerciseMinutes()     // è·å–è¿åŠ¨
- updateDebugData()          // æ›´æ–°è°ƒè¯•æ•°æ®

MVVMä½“ç°ï¼š
âœ“ å°è£…HealthKitå¤æ‚çš„APIè°ƒç”¨
âœ“ æä¾›ç»Ÿä¸€çš„æ•°æ®æ¥å£ç»™View
âœ“ å¼‚æ­¥æ“ä½œå¤„ç†
âœ“ çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†
```

#### 2.3.3 Viewå±‚ï¼ˆè§†å›¾ï¼‰

**1. ContentViewï¼ˆä¸»è§†å›¾ï¼‰**
```swift
ä½ç½®ï¼šVitalityPact/ContentView.swift

ç±»å‹ï¼šstructï¼ˆSwiftUI Viewï¼‰

æ ¸å¿ƒèŒè´£ï¼š
- åº”ç”¨ä¸»ç•Œé¢å¸ƒå±€
- åè°ƒå„ä¸ªå­è§†å›¾
- çŠ¶æ€å±•ç¤ºå’Œäº¤äº’å…¥å£
- åŠ¨ç”»å±•ç¤º

ä¾èµ–çš„ViewModelï¼š
@EnvironmentObject var healthManager: HealthStoreManager
@EnvironmentObject var gameState: GameStateManager
@StateObject private var userSettings = UserSettings.shared
@ObservedObject var imageCharacterManager = ImageCharacterManager.shared

å­è§†å›¾ç»„æˆï¼š
- TopStatusBar              // é¡¶éƒ¨çŠ¶æ€æ 
- DynamicCharacterView      // åŠ¨æ€è§’è‰²è§†å›¾
- DialogueBubbleView        // å¯¹è¯æ°”æ³¡
- HealthInfoCard            // å¥åº·ä¿¡æ¯å¡ç‰‡
- RewardAnimationView       // å¥–åŠ±åŠ¨ç”»

MVVMä½“ç°ï¼š
âœ“ çº¯UIå£°æ˜ï¼Œæ— ä¸šåŠ¡é€»è¾‘
âœ“ é€šè¿‡@EnvironmentObjectè·å–ViewModel
âœ“ æ•°æ®ç»‘å®šè‡ªåŠ¨æ›´æ–°UI
âœ“ ç”¨æˆ·äº¤äº’é€šè¿‡ViewModelå¤„ç†
```

**2. ChatViewï¼ˆèŠå¤©è§†å›¾ï¼‰**
```swift
ä½ç½®ï¼šVitalityPact/Views/ChatView.swift

æ ¸å¿ƒèŒè´£ï¼š
- ç”¨æˆ·ä¸AIå¯¹è¯ç•Œé¢
- æ¶ˆæ¯åˆ—è¡¨å±•ç¤º
- è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®
- åŠ è½½çŠ¶æ€å±•ç¤º

æ•°æ®æµï¼š
ç”¨æˆ·è¾“å…¥ â†’ AIService â†’ ViewModel â†’ Viewæ›´æ–°

MVVMä½“ç°ï¼š
âœ“ Viewåªè´Ÿè´£UIå±•ç¤º
âœ“ è°ƒç”¨AIServiceè·å–å›å¤
âœ“ çŠ¶æ€ç®¡ç†æ¸…æ™°
```

**3. HealthHistoryViewï¼ˆå¥åº·å†å²è§†å›¾ï¼‰**
```swift
ä½ç½®ï¼šVitalityPact/Views/HealthHistoryView.swift

æ ¸å¿ƒèŒè´£ï¼š
- å¤šç»´åº¦å†å²æ•°æ®å±•ç¤º
- è¶‹åŠ¿åˆ†æå¯è§†åŒ–
- AIåˆ†ææŠ¥å‘Šå±•ç¤º
- æ—¶é—´èŒƒå›´é€‰æ‹©

æ•°æ®æ¥æºï¼š
GameStateManager.healthHistory

MVVMä½“ç°ï¼š
âœ“ ä»ViewModelè·å–å¤„ç†å¥½çš„æ•°æ®
âœ“ ä¸“æ³¨äºæ•°æ®å¯è§†åŒ–
âœ“ ä¸ç›´æ¥è®¿é—®Model
```

### 2.4 MVVMæ•°æ®ç»‘å®šæœºåˆ¶

SwiftUIä¸ºMVVMæ¶æ„æä¾›äº†åŸç”Ÿæ”¯æŒï¼Œé€šè¿‡ä¸€ç³»åˆ—å±æ€§åŒ…è£…å™¨å®ç°å“åº”å¼æ•°æ®ç»‘å®šã€‚è¿™ç§æœºåˆ¶ä½¿å¾—æ•°æ®å˜åŒ–èƒ½å¤Ÿè‡ªåŠ¨è§¦å‘UIæ›´æ–°ï¼Œå¼€å‘è€…æ— éœ€ç¼–å†™æ‰‹åŠ¨åˆ·æ–°ç•Œé¢çš„ä»£ç ã€‚

**@Publishedå‘å¸ƒè€…æœºåˆ¶**ï¼šåœ¨ViewModelç±»ä¸­ï¼Œä½¿ç”¨@Publishedæ ‡è®°çš„å±æ€§åœ¨å€¼å‘ç”Ÿå˜åŒ–æ—¶ä¼šè‡ªåŠ¨å‘é€é€šçŸ¥ã€‚Combineæ¡†æ¶åœ¨åº•å±‚å¤„ç†å‘å¸ƒ-è®¢é˜…æœºåˆ¶ï¼Œå½“å±æ€§è¢«ä¿®æ”¹æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨objectWillChange.send()æ–¹æ³•ï¼Œé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…æ•°æ®å³å°†å˜åŒ–ã€‚è¿™ç§è‡ªåŠ¨åŒ–çš„é€šçŸ¥æœºåˆ¶æ˜¯å“åº”å¼ç¼–ç¨‹çš„æ ¸å¿ƒã€‚

**@ObservedObjectè§‚å¯Ÿå¯¹è±¡**ï¼šåœ¨Viewä¸­ä½¿ç”¨@ObservedObjectå£°æ˜å¯¹ViewModelçš„å¼•ç”¨ï¼Œå»ºç«‹èµ·è§‚å¯Ÿå…³ç³»ã€‚å½“ViewModelä¸­ä»»ä½•@Publishedå±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒæŒæœ‰è¯¥å¼•ç”¨çš„Viewä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—bodyå±æ€§ï¼Œæ›´æ–°ç•Œé¢æ˜¾ç¤ºã€‚è¿™ç§æ–¹å¼é€‚ç”¨äºéœ€è¦ä»çˆ¶Viewä¼ é€’ç»™å­Viewçš„ViewModelå¯¹è±¡ã€‚

**@EnvironmentObjectç¯å¢ƒå¯¹è±¡**ï¼šè¿™æ˜¯SwiftUIæä¾›çš„ä¾èµ–æ³¨å…¥æœºåˆ¶ï¼Œè§£å†³äº†æ·±å±‚è§†å›¾åµŒå¥—ä¸­çš„å¯¹è±¡ä¼ é€’é—®é¢˜ã€‚åœ¨åº”ç”¨çš„æ ¹è§†å›¾é€šè¿‡environmentObjectä¿®é¥°ç¬¦æ³¨å…¥å¯¹è±¡åï¼Œä»»æ„å±‚çº§çš„å­è§†å›¾éƒ½å¯ä»¥é€šè¿‡@EnvironmentObjectç›´æ¥è·å–ï¼Œæ— éœ€é€šè¿‡ä¸­é—´å±‚é€çº§ä¼ é€’ã€‚æœ¬é¡¹ç›®åœ¨Appå…¥å£æ³¨å…¥HealthStoreManagerå’ŒGameStateManagerï¼Œä½¿å¾—æ•´ä¸ªåº”ç”¨çš„æ‰€æœ‰è§†å›¾éƒ½èƒ½ä¾¿æ·è®¿é—®è¿™äº›æ ¸å¿ƒå¯¹è±¡ã€‚

**@StateObjectçŠ¶æ€å¯¹è±¡**ï¼šç”¨äºViewæ‹¥æœ‰å¹¶ç®¡ç†ViewModelçš„åœºæ™¯ã€‚ä¸@ObservedObjectçš„å…³é”®åŒºåˆ«åœ¨äºç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š@StateObjectç¡®ä¿åœ¨Viewçš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œå¯¹è±¡åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ã€‚å³ä½¿çˆ¶Viewé‡å»ºå¯¼è‡´å­Viewé‡æ–°æ„å»ºï¼Œ@StateObjectæ ‡è®°çš„å¯¹è±¡ä¹Ÿä¼šè¢«ä¿ç•™ï¼Œé¿å…äº†ä¸å¿…è¦çš„é‡æ–°åˆå§‹åŒ–ã€‚è¿™åœ¨å®ç°å•ä¾‹æ¨¡å¼å’Œä¿æŒçŠ¶æ€ä¸€è‡´æ€§æ—¶ç‰¹åˆ«é‡è¦ã€‚

**æ•°æ®æµåŠ¨æœºåˆ¶**ï¼šç”¨æˆ·åœ¨ç•Œé¢ä¸Šçš„æ“ä½œï¼ˆç‚¹å‡»ã€è¾“å…¥ã€æ»‘åŠ¨ï¼‰é¦–å…ˆè¢«Viewæ•è·ï¼ŒViewå°†äº‹ä»¶å§”æ‰˜ç»™ViewModelçš„ç›¸åº”æ–¹æ³•å¤„ç†ã€‚ViewModelæ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œå¯èƒ½è°ƒç”¨Serviceå±‚è·å–æ•°æ®ï¼Œç„¶åæ›´æ–°Modelå¹¶ä¿®æ”¹@Publishedå±æ€§ã€‚Combineæ¡†æ¶è‡ªåŠ¨å‘é€é€šçŸ¥ï¼ŒSwiftUIå¼•æ“æ¥æ”¶é€šçŸ¥åé‡æ–°è®¡ç®—affected Viewçš„bodyï¼Œé€šè¿‡é«˜æ•ˆçš„å·®å¼‚åŒ–ç®—æ³•åªæ›´æ–°å®é™…å˜åŒ–çš„UIå…ƒç´ ã€‚æ•´ä¸ªè¿‡ç¨‹å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œå½¢æˆäº†æ¸…æ™°çš„å•å‘æ•°æ®æµã€‚
                Text(gameState.dialogue)  // ç»‘å®šåˆ°ViewModel
            }
            
            // åˆ·æ–°å¯¹è¯æŒ‰é’®
            Button("åˆ·æ–°å¯¹è¯") {
                // 2. è§¦å‘ViewModelæ–¹æ³•
                gameState.generateDialogue(
                    for: healthManager.healthData
                )
            }
        }
    }
}

// 3. ViewModelå±‚ - GameStateManager.swift
class GameStateManager: ObservableObject {
    @Published var dialogue: String = ""
    @Published var isLoadingDialogue: Bool = false
    
    func generateDialogue(for healthData: HealthData) {
        isLoadingDialogue = true  // 4. æ›´æ–°åŠ è½½çŠ¶æ€ â†’ UIè‡ªåŠ¨æ›´æ–°
        
        Task {
            do {
                // 5. è°ƒç”¨Serviceå±‚
                let response = try await AIService.shared.generateDialogue(
                    characterType: currentCharacterType,
                    healthData: healthData
                )
                
                await MainActor.run {
                    // 6. æ›´æ–°æ•°æ® â†’ UIè‡ªåŠ¨æ›´æ–°
                    self.dialogue = response
                    self.isLoadingDialogue = false
                }
            } catch {
                await MainActor.run {
                    self.dialogue = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"
                    self.isLoadingDialogue = false
                }
            }
        }
    }
}

æ•°æ®æµæ€»ç»“ï¼š
ç”¨æˆ·ç‚¹å‡» â†’ Viewè°ƒç”¨ViewModelæ–¹æ³• â†’ ViewModelæ›´æ–°@Publishedå±æ€§ 
â†’ Combineå‘é€é€šçŸ¥ â†’ SwiftUIè‡ªåŠ¨æ›´æ–°UI

MVVMä¼˜åŠ¿ä½“ç°ï¼š
âœ“ Viewå®Œå…¨ä¸çŸ¥é“æ•°æ®å¦‚ä½•è·å–
âœ“ ViewModelå®Œå…¨ä¸çŸ¥é“UIå¦‚ä½•æ¸²æŸ“
âœ“ èŒè´£åˆ†ç¦»æ¸…æ™°ï¼Œæ˜“äºæµ‹è¯•å’Œç»´æŠ¤
```

---

## 3. æ ¸å¿ƒæŠ€æœ¯æ ˆ

### 3.1 å¼€å‘è¯­è¨€ä¸æ¡†æ¶

#### 3.1.1 Swift 5.9
- **ç°ä»£åŒ–è¯­æ³•**ï¼šasync/awaitã€Actorã€Structured Concurrency
- **ç±»å‹å®‰å…¨**ï¼šå¼ºç±»å‹ç³»ç»Ÿï¼Œç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
- **æ€§èƒ½ä¼˜åŠ¿**ï¼šæ¥è¿‘C/C++çš„æ€§èƒ½ï¼Œæ¯”Objective-Cå¿«2-3å€
- **å†…å­˜å®‰å…¨**ï¼šARCè‡ªåŠ¨å†…å­˜ç®¡ç†

#### 3.1.2 SwiftUI
```swift
é€‰æ‹©ç†ç”±ï¼š
1. å£°æ˜å¼UIç¼–ç¨‹
   - ä»£ç å³æ–‡æ¡£ï¼Œæ˜“äºç†è§£
   - å¤©ç„¶æ”¯æŒMVVMæ¶æ„
   
2. è‡ªåŠ¨çŠ¶æ€ç®¡ç†
   - @Stateã€@Bindingã€@ObservedObject
   - æ— éœ€æ‰‹åŠ¨æ›´æ–°UI
   
3. è·¨å¹³å°æ”¯æŒ
   - iOSã€iPadOSã€macOSã€watchOSå…±äº«ä»£ç 
   - ä¸€æ¬¡ç¼–å†™ï¼Œå¤šå¹³å°éƒ¨ç½²
   
4. å®æ—¶é¢„è§ˆ
   - Canvaså³æ—¶é¢„è§ˆ
   - æé«˜å¼€å‘æ•ˆç‡50%+
```

#### 3.1.3 Combine
```swift
åŠŸèƒ½ï¼šå“åº”å¼ç¼–ç¨‹æ¡†æ¶

ä½¿ç”¨åœºæ™¯ï¼š
1. æ•°æ®æµç®¡ç†
   @Published â†’ objectWillChange â†’ Viewæ›´æ–°

2. å¼‚æ­¥äº‹ä»¶å¤„ç†
   Futureã€Promiseæ¨¡å¼

3. æ“ä½œç¬¦ç»„åˆ
   mapã€filterã€debounceç­‰

ä»£ç ç¤ºä¾‹ï¼š
class GameStateManager: ObservableObject {
    @Published var dialogue: String = ""
    
    // Combineè‡ªåŠ¨ç®¡ç†å‘å¸ƒè®¢é˜…å…³ç³»
    // dialogueå˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
}
```

### 3.2 Appleæ¡†æ¶é›†æˆ

#### 3.2.1 HealthKit
```swift
ä½ç½®ï¼šServices/HealthStoreManager.swift

é›†æˆå†…å®¹ï¼š
1. HKHealthStore - å¥åº·æ•°æ®å­˜å‚¨
2. HKQuantityType - æ•°é‡ç±»å‹æ•°æ®ï¼ˆæ­¥æ•°ã€å¿ƒç‡ï¼‰
3. HKCategoryType - åˆ†ç±»æ•°æ®ï¼ˆç¡çœ ï¼‰
4. HKStatisticsQuery - ç»Ÿè®¡æŸ¥è¯¢

æˆæƒæµç¨‹ï¼š
1. Info.plisté…ç½®æƒé™è¯´æ˜
2. è¯·æ±‚è¯»å–æƒé™
3. å¼‚æ­¥è·å–æ•°æ®
4. å¤„ç†æˆæƒå¤±è´¥æƒ…å†µ

æ•°æ®è·å–ï¼š
// è·å–ä»Šæ—¥æ­¥æ•°
private func fetchSteps() async -> Int {
    let stepType = HKQuantityType.quantityType(
        forIdentifier: .stepCount
    )!
    let now = Date()
    let startOfDay = Calendar.current.startOfDay(for: now)
    let predicate = HKQuery.predicateForSamples(
        withStart: startOfDay,
        end: now,
        options: .strictStartDate
    )
    
    return await withCheckedContinuation { continuation in
        let query = HKStatisticsQuery(
            quantityType: stepType,
            quantitySamplePredicate: predicate,
            options: .cumulativeSum
        ) { _, result, _ in
            let steps = result?.sumQuantity()?
                .doubleValue(for: .count()) ?? 0
            continuation.resume(returning: Int(steps))
        }
        healthStore.execute(query)
    }
}
```

#### 3.2.2 UserDefaults
```swift
ç”¨é€”ï¼šè½»é‡çº§æ•°æ®æŒä¹…åŒ–

å­˜å‚¨å†…å®¹ï¼š
1. ç”¨æˆ·è®¾ç½®ï¼ˆselectedCharacterTypeï¼‰
2. è§£é”çŠ¶æ€ï¼ˆunlockedCharacterIdsï¼‰
3. æ¸¸æˆè¿›åº¦ï¼ˆä¼™ä¼´ç­‰çº§ã€ç»éªŒï¼‰

ä¼˜åŠ¿ï¼š
âœ“ ç®€å•æ˜“ç”¨
âœ“ è‡ªåŠ¨åŒæ­¥
âœ“ é€‚åˆå°æ•°æ®é‡

ç¤ºä¾‹ï¼š
UserDefaults.standard.set(
    characterId,
    forKey: "selectedCharacterId"
)
```

#### 3.2.3 WidgetKit
```swift
ä½ç½®ï¼šVitalityPactWidget/

åŠŸèƒ½ï¼šä¸»å±å¹•å°ç»„ä»¶

å®ç°ï¼š
1. Widgetå®šä¹‰
2. Timeline Provider
3. æ•°æ®å…±äº«ï¼ˆApp Groupï¼‰
4. åˆ·æ–°ç­–ç•¥

æŠ€æœ¯è¦ç‚¹ï¼š
- TimelineEntryå®šä¹‰æ•°æ®ç»“æ„
- getTimelineæä¾›æ›´æ–°æ•°æ®
- App Groupå…±äº«UserDefaults
```

### 3.3 ç¬¬ä¸‰æ–¹æœåŠ¡

#### 3.3.1 AIå¯¹è¯æœåŠ¡ï¼ˆSiliconFlowï¼‰
```swift
ä½ç½®ï¼šServices/AIService.swift

APIï¼šhttps://api.siliconflow.cn/v1/chat/completions
æ¨¡å‹ï¼šQwen/Qwen2.5-7B-Instruct

é›†æˆæ–¹å¼ï¼š
1. URLSessionå‘èµ·HTTPè¯·æ±‚
2. JSONæ ¼å¼æ•°æ®äº¤æ¢
3. async/awaitå¼‚æ­¥å¤„ç†
4. é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

è¯·æ±‚ç»“æ„ï¼š
{
    "model": "Qwen/Qwen2.5-7B-Instruct",
    "messages": [
        {"role": "system", "content": "ç³»ç»Ÿæç¤ºè¯"},
        {"role": "user", "content": "ç”¨æˆ·è¾“å…¥"}
    ],
    "max_tokens": 80,
    "temperature": 1.1
}

å“åº”å¤„ç†ï¼š
1. è§£æJSONå“åº”
2. æå–å¯¹è¯å†…å®¹
3. æ›´æ–°ViewModel
4. è§¦å‘UIåˆ·æ–°
```

---

## 4. é¡¹ç›®ç»“æ„åˆ†æ

### 4.1 å®Œæ•´ç›®å½•ç»“æ„

```
VitalityPact/
â”œâ”€â”€ VitalityPact/                    # ä¸»åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ VitalityPactApp.swift        # Appå…¥å£
â”‚   â”œâ”€â”€ ContentView.swift            # ä¸»è§†å›¾
â”‚   â”œâ”€â”€ SceneDelegate.swift          # åœºæ™¯ä»£ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ Models/                      # ğŸ“¦ Modelå±‚
â”‚   â”‚   â”œâ”€â”€ HealthData.swift         # å¥åº·æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ HealthHistory.swift      # å†å²è®°å½•æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ CharacterType.swift      # è§’è‰²ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ ImageCharacter.swift     # å›¾ç‰‡è§’è‰²ç³»ç»Ÿ
â”‚   â”‚   â””â”€â”€ PartnerAttributes.swift  # ä¼™ä¼´å±æ€§æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ Views/                       # ğŸ¨ Viewå±‚
â”‚   â”‚   â”œâ”€â”€ ChatView.swift           # èŠå¤©ç•Œé¢
â”‚   â”‚   â”œâ”€â”€ HealthHistoryView.swift  # å¥åº·å†å²
â”‚   â”‚   â”œâ”€â”€ ImageCharacterView.swift # è§’è‰²é€‰æ‹©
â”‚   â”‚   â”œâ”€â”€ PartnerStatsView.swift   # ä¼™ä¼´å±æ€§
â”‚   â”‚   â””â”€â”€ DebugPanelView.swift     # è°ƒè¯•é¢æ¿
â”‚   â”‚
â”‚   â”œâ”€â”€ ViewModels/                  # ğŸ”„ ViewModelå±‚
â”‚   â”‚   â””â”€â”€ GameStateManager.swift   # æ¸¸æˆçŠ¶æ€ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ Services/                    # ğŸ› ï¸ Serviceå±‚
â”‚   â”‚   â”œâ”€â”€ HealthStoreManager.swift # HealthKitç®¡ç†
â”‚   â”‚   â””â”€â”€ AIService.swift          # AIå¯¹è¯æœåŠ¡
â”‚   â”‚
â”‚   â”œâ”€â”€ Utils/                       # ğŸ”§ å·¥å…·å±‚
â”‚   â”‚   â””â”€â”€ WidgetDataManager.swift  # Widgetæ•°æ®ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ Assets.xcassets/             # èµ„æºæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ AppIcon.appiconset/      # åº”ç”¨å›¾æ ‡
â”‚   â”‚   â””â”€â”€ AccentColor.colorset/    # ä¸»é¢˜è‰²
â”‚   â”‚
â”‚   â””â”€â”€ VitalityPact.entitlements    # æƒé™é…ç½®
â”‚
â”œâ”€â”€ VitalityPactWidget/              # Widgetæ‰©å±•
â”‚   â”œâ”€â”€ VitalityPactWidget.swift     # Widgetä¸»æ–‡ä»¶
â”‚   â”œâ”€â”€ VitalityPactWidgetBundle.swift
â”‚   â”œâ”€â”€ VitalityPactWidgetControl.swift
â”‚   â”œâ”€â”€ Info.plist
â”‚   â””â”€â”€ Assets.xcassets/
â”‚
â”œâ”€â”€ VitalityPact.xcodeproj/          # Xcodeé¡¹ç›®æ–‡ä»¶
â”œâ”€â”€ README.md                        # é¡¹ç›®è¯´æ˜
â””â”€â”€ PROJECT_DOCUMENTATION.md         # è¯¦ç»†æ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£ï¼‰

æ€»è®¡æ–‡ä»¶æ•°ï¼š30+
æ€»ä»£ç è¡Œæ•°ï¼š5000+
æ¶æ„æ¸…æ™°åº¦ï¼šâ­â­â­â­â­
```

### 4.2 æ–‡ä»¶èŒè´£è¯´æ˜

#### 4.2.1 æ ¸å¿ƒæ–‡ä»¶

**VitalityPactApp.swiftï¼ˆåº”ç”¨å…¥å£ï¼‰**
```swift
èŒè´£ï¼š
1. Appç”Ÿå‘½å‘¨æœŸç®¡ç†
2. å…¨å±€ViewModelåˆå§‹åŒ–å’Œæ³¨å…¥
3. HealthKitæˆæƒè¯·æ±‚
4. é¦–æ¬¡å¯åŠ¨åˆå§‹åŒ–

å…³é”®ä»£ç ï¼š
@main
struct VitalityPactApp: App {
    @StateObject private var healthManager = HealthStoreManager.shared
    @StateObject private var gameState = GameStateManager()
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(healthManager)
                .environmentObject(gameState)
                .task {
                    await healthManager.requestAuthorization()
                }
        }
    }
}
```

**ContentView.swiftï¼ˆä¸»è§†å›¾ï¼‰**
```swift
èŒè´£ï¼š
1. åº”ç”¨ä¸»ç•Œé¢å¸ƒå±€
2. åè°ƒå„ä¸ªåŠŸèƒ½æ¨¡å—
3. çŠ¶æ€ç®¡ç†å’ŒåŠ¨ç”»
4. ç”¨æˆ·äº¤äº’å…¥å£

ç»„æˆéƒ¨åˆ†ï¼š
- TopStatusBar: é¡¶éƒ¨çŠ¶æ€æ ï¼ˆé‡‘å¸ã€æŒ‰é’®ï¼‰
- DynamicCharacterView: åŠ¨æ€è§’è‰²æ˜¾ç¤º
- DialogueBubbleView: å¯¹è¯æ°”æ³¡
- HealthInfoCard: å¥åº·ä¿¡æ¯å¡ç‰‡
- RewardAnimationView: å¥–åŠ±åŠ¨ç”»

ä»£ç è¡Œæ•°ï¼š~1200è¡Œ
```

#### 4.2.2 Modelå±‚æ–‡ä»¶

**HealthData.swift**
```swift
æ ¸å¿ƒå†…å®¹ï¼š
- struct HealthData: å¥åº·æ•°æ®ç»“æ„
- struct CharacterData: è§’è‰²æ•°æ®ï¼ˆå·²åºŸå¼ƒï¼‰
- enum CharacterState: è§’è‰²çŠ¶æ€æšä¸¾
- è¯„åˆ†è®¡ç®—é€»è¾‘
- é‡‘å¸æ›´æ–°é€»è¾‘

ä»£ç è¡Œæ•°ï¼š~125è¡Œ
è®¾è®¡æ¨¡å¼ï¼šå€¼ç±»å‹ï¼ˆstructï¼‰
```

**HealthHistory.swift**
```swift
æ ¸å¿ƒå†…å®¹ï¼š
- struct DailyHealthRecord: æ¯æ—¥è®°å½•
- struct HealthHistoryAnalysis: åˆ†æç»“æœ
- enum HealthTrend: è¶‹åŠ¿ç±»å‹
- class HealthHistoryManager: ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰

åŠŸèƒ½ï¼š
- è®°å½•å­˜å‚¨å’ŒæŸ¥è¯¢
- è¶‹åŠ¿åˆ†æ
- å¼‚å¸¸æ£€æµ‹
- æ•°æ®æŒä¹…åŒ–

ä»£ç è¡Œæ•°ï¼š~270è¡Œ
è®¾è®¡æ¨¡å¼ï¼šå•ä¾‹æ¨¡å¼ + è§‚å¯Ÿè€…æ¨¡å¼
```

**CharacterType.swift**
```swift
æ ¸å¿ƒå†…å®¹ï¼š
- enum CharacterType: 4ç§è§’è‰²ç±»å‹
- enum HealthLevel: 5ä¸ªå¥åº·ç­‰çº§
- class UserSettings: ç”¨æˆ·è®¾ç½®ç®¡ç†

åŠŸèƒ½ï¼š
- è§’è‰²å±æ€§å®šä¹‰
- è¡¨æƒ…æ˜ å°„
- ä¸»é¢˜è‰²é…ç½®
- å¯¹è¯é£æ ¼å®šä¹‰

ä»£ç è¡Œæ•°ï¼š~420è¡Œ
è®¾è®¡æ¨¡å¼ï¼šæšä¸¾ + å•ä¾‹
```

**ImageCharacter.swift**
```swift
æ ¸å¿ƒå†…å®¹ï¼š
- struct ImageCharacter: å›¾ç‰‡è§’è‰²
- enum CharacterCategory: è§’è‰²åˆ†ç±»
- class ImageCharacterManager: ç®¡ç†å™¨

åŠŸèƒ½ï¼š
- 6+ä¸ªå†…ç½®è§’è‰²
- è§£é”ç³»ç»Ÿ
- å›¾ç‰‡æ˜ å°„
- çŠ¶æ€æŒä¹…åŒ–

ä»£ç è¡Œæ•°ï¼š~290è¡Œ
è®¾è®¡æ¨¡å¼ï¼šå·¥å‚æ¨¡å¼ + å•ä¾‹
```

**PartnerAttributes.swift**
```swift
æ ¸å¿ƒå†…å®¹ï¼š
- struct PartnerAttributes: RPGå±æ€§
- class PartnerAttributesManager: ç®¡ç†å™¨

åŠŸèƒ½ï¼š
- ç­‰çº§ç³»ç»Ÿ
- ç»éªŒå€¼è®¡ç®—
- 4ç»´å±æ€§æˆé•¿
- å‡çº§é€»è¾‘

ä»£ç è¡Œæ•°ï¼š~350è¡Œ
è®¾è®¡æ¨¡å¼ï¼šRPGæ•°å€¼æ¨¡å‹
```

#### 4.2.3 ViewModelå±‚æ–‡ä»¶

**GameStateManager.swift**
```swift
æ ¸å¿ƒå†…å®¹ï¼š
- class GameStateManager: ObservableObject

@Publishedå±æ€§ï¼š
- dialogue: String                    // å½“å‰å¯¹è¯
- isLoadingDialogue: Bool            // åŠ è½½çŠ¶æ€
- showChestAnimation: Bool           // å®ç®±åŠ¨ç”»
- showLevelUpAnimation: Bool         // å‡çº§åŠ¨ç”»
- currentExp: Int                    // å½“å‰ç»éªŒ
- currentLevel: Int                  // å½“å‰ç­‰çº§

å…³é”®æ–¹æ³•ï¼š
- generateDialogue(for:)             // ç”Ÿæˆå¯¹è¯
- updateGameState(from:)             // æ›´æ–°çŠ¶æ€
- addExperience(_:)                  // å¢åŠ ç»éªŒ
- checkLevelUp()                     // æ£€æŸ¥å‡çº§
- showReward()                       // æ˜¾ç¤ºå¥–åŠ±

ä¾èµ–å…³ç³»ï¼š
- AIService: ç”Ÿæˆå¯¹è¯
- HealthStoreManager: è·å–å¥åº·æ•°æ®
- PartnerAttributesManager: ç®¡ç†å±æ€§

ä»£ç è¡Œæ•°ï¼š~550è¡Œ
èŒè´£ï¼šæ¸¸æˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ç®¡ç†
```

**HealthStoreManager.swift**
```swift
æ ¸å¿ƒå†…å®¹ï¼š
- class HealthStoreManager: ObservableObject

@Publishedå±æ€§ï¼š
- healthData: HealthData              // å¥åº·æ•°æ®
- isLoading: Bool                    // åŠ è½½çŠ¶æ€
- isAuthorized: Bool                 // æˆæƒçŠ¶æ€
- debugMode: Bool                    // è°ƒè¯•æ¨¡å¼
- errorMessage: String?              // é”™è¯¯ä¿¡æ¯

å…³é”®æ–¹æ³•ï¼š
- requestAuthorization()             // è¯·æ±‚æˆæƒ
- fetchAllData()                     // è·å–æ‰€æœ‰æ•°æ®
- fetchSteps()                       // è·å–æ­¥æ•°
- fetchSleepHours()                  // è·å–ç¡çœ 
- fetchExerciseMinutes()             // è·å–è¿åŠ¨
- fetchHeartRate()                   // è·å–å¿ƒç‡
- updateDebugData()                  // æ›´æ–°è°ƒè¯•æ•°æ®

æŠ€æœ¯ç‰¹ç‚¹ï¼š
- async/awaitå¼‚æ­¥å¤„ç†
- withCheckedContinuationæ¡¥æ¥å›è°ƒ
- MainActorç¡®ä¿UIæ›´æ–°åœ¨ä¸»çº¿ç¨‹
- é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†

ä»£ç è¡Œæ•°ï¼š~220è¡Œ
èŒè´£ï¼šHealthKitæ•°æ®æŠ½è±¡å±‚
```

#### 4.2.4 Viewå±‚æ–‡ä»¶

**ChatView.swift**
```swift
åŠŸèƒ½ï¼šAIå¯¹è¯ç•Œé¢

ç»„ä»¶ï¼š
- æ¶ˆæ¯åˆ—è¡¨ï¼ˆScrollViewï¼‰
- è¾“å…¥æ¡†ï¼ˆTextFieldï¼‰
- å‘é€æŒ‰é’®
- åŠ è½½æŒ‡ç¤ºå™¨

ç‰¹ç‚¹ï¼š
- è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
- æ”¯æŒå¤šè½®å¯¹è¯
- åŠ è½½çŠ¶æ€æç¤º
- é”™è¯¯å¤„ç†

ä»£ç è¡Œæ•°ï¼š~280è¡Œ
```

**HealthHistoryView.swift**
```swift
åŠŸèƒ½ï¼šå¥åº·å†å²æ•°æ®å±•ç¤º

ç»„ä»¶ï¼š
- æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ï¼ˆ7/14/30/90å¤©ï¼‰
- æ¦‚è§ˆå¡ç‰‡ï¼ˆå¹³å‡æ•°æ®ï¼‰
- è¯¦ç»†æ•°æ®åˆ—è¡¨
- è¶‹åŠ¿åˆ†æ
- AIåˆ†ææŠ¥å‘Š

æŠ€æœ¯äº®ç‚¹ï¼š
- åŠ¨æ€æ•°æ®æŸ¥è¯¢
- è¶‹åŠ¿è®¡ç®—
- AIåˆ†æé›†æˆ
- å¯è§†åŒ–å±•ç¤º

ä»£ç è¡Œæ•°ï¼š~450è¡Œ
```

**ImageCharacterView.swift**
```swift
åŠŸèƒ½ï¼šè§’è‰²é€‰æ‹©å’Œç®¡ç†

ç»„ä»¶ï¼š
- æ¨¡å¼åˆ‡æ¢ï¼ˆEmoji/å›¾ç‰‡ï¼‰
- è§’è‰²ç½‘æ ¼å±•ç¤º
- è§£é”çŠ¶æ€æ˜¾ç¤º
- è§£é”ç¡®è®¤å¯¹è¯æ¡†

ç‰¹ç‚¹ï¼š
- é”å®š/è§£é”çŠ¶æ€
- é‡‘å¸æ¶ˆè€—é€»è¾‘
- è§’è‰²é¢„è§ˆ
- åˆ†ç±»å±•ç¤º

ä»£ç è¡Œæ•°ï¼š~420è¡Œ
```

**PartnerStatsView.swift**
```swift
åŠŸèƒ½ï¼šä¼™ä¼´å±æ€§å±•ç¤º

ç»„ä»¶ï¼š
- ç­‰çº§å’Œç»éªŒæ¡
- 4ç»´å±æ€§é›·è¾¾å›¾
- å±æ€§æ•°å€¼æ˜¾ç¤º
- æˆé•¿å†å²

æŠ€æœ¯äº®ç‚¹ï¼š
- è‡ªå®šä¹‰ç»˜åˆ¶
- åŠ¨ç”»æ•ˆæœ
- æ•°æ®å¯è§†åŒ–

ä»£ç è¡Œæ•°ï¼š~320è¡Œ
```

**DebugPanelView.swift**
```swift
åŠŸèƒ½ï¼šè°ƒè¯•å’Œæ¼”ç¤ºå·¥å…·

ç»„ä»¶ï¼š
- æ•°æ®è°ƒèŠ‚æ»‘å—
- åœºæ™¯é¢„è®¾æŒ‰é’®
- å†å²è®°å½•åŠ è½½
- é‡‘å¸ç®¡ç†
- è§’è‰²è§£é”

ç”¨é€”ï¼š
- å¿«é€Ÿæµ‹è¯•ä¸åŒåœºæ™¯
- æ¼”ç¤ºåº”ç”¨åŠŸèƒ½
- å¼€å‘è°ƒè¯•

ä»£ç è¡Œæ•°ï¼š~1075è¡Œ
```

#### 4.2.5 Serviceå±‚æ–‡ä»¶

**AIService.swift**
```swift
åŠŸèƒ½ï¼šAIå¯¹è¯æœåŠ¡å°è£…

æ ¸å¿ƒæ–¹æ³•ï¼š
- generateDialogue(characterType:healthData:)
  // ç”Ÿæˆè§’è‰²å¯¹è¯
  
- callChatAPI(messages:maxTokens:temperature:)
  // é€šç”¨èŠå¤©APIè°ƒç”¨
  
- callDetailedAnalysisAPI(prompt:)
  // è¯¦ç»†åˆ†ææŠ¥å‘Šç”Ÿæˆ

æŠ€æœ¯å®ç°ï¼š
- URLSessionç½‘ç»œè¯·æ±‚
- JSONç¼–è§£ç 
- async/awaitå¼‚æ­¥å¤„ç†
- è¶…æ—¶æ§åˆ¶
- é”™è¯¯é‡è¯•

æç¤ºè¯å·¥ç¨‹ï¼š
- ç³»ç»Ÿæç¤ºè¯å®šä¹‰è§’è‰²æ€§æ ¼
- ç”¨æˆ·æç¤ºè¯åŒ…å«å¥åº·æ•°æ®å’Œä¸Šä¸‹æ–‡
- æ¸©åº¦å‚æ•°æ§åˆ¶åˆ›æ„ç¨‹åº¦
- Tokené™åˆ¶æ§åˆ¶å“åº”é•¿åº¦

ä»£ç è¡Œæ•°ï¼š~450è¡Œ
```

### 4.3 ä»£ç ç»Ÿè®¡

```
æ–‡ä»¶ç±»å‹ç»Ÿè®¡ï¼š
â”œâ”€â”€ Swiftæºæ–‡ä»¶ï¼š        20ä¸ª
â”œâ”€â”€ Storyboardï¼š         1ä¸ª
â”œâ”€â”€ Assetsï¼š            2ç»„
â”œâ”€â”€ Entitlementsï¼š      2ä¸ª
â”œâ”€â”€ Info.plistï¼š        2ä¸ª
â””â”€â”€ é¡¹ç›®é…ç½®ï¼š           è‹¥å¹²

ä»£ç è¡Œæ•°ç»Ÿè®¡ï¼ˆä¸å«ç©ºè¡Œå’Œæ³¨é‡Šï¼‰ï¼š
â”œâ”€â”€ Modelå±‚ï¼š           ~1455è¡Œ
â”œâ”€â”€ Viewå±‚ï¼š            ~2545è¡Œ
â”œâ”€â”€ ViewModelå±‚ï¼š       ~770è¡Œ
â”œâ”€â”€ Serviceå±‚ï¼š         ~670è¡Œ
â”œâ”€â”€ Utilså±‚ï¼š           ~150è¡Œ
â””â”€â”€ æ€»è®¡ï¼š             ~5590è¡Œ

æ–‡ä»¶å¤§å°ç»Ÿè®¡ï¼š
â”œâ”€â”€ æœ€å¤§æ–‡ä»¶ï¼šContentView.swift (1217è¡Œ)
â”œâ”€â”€ æœ€å°æ–‡ä»¶ï¼šSceneDelegate.swift (30è¡Œ)
â””â”€â”€ å¹³å‡å¤§å°ï¼š~280è¡Œ/æ–‡ä»¶

å¤æ‚åº¦åˆ†æï¼š
â”œâ”€â”€ å¾ªç¯å¤æ‚åº¦ï¼šä¸­ç­‰ï¼ˆå¤§éƒ¨åˆ†å‡½æ•°<10ï¼‰
â”œâ”€â”€ åµŒå¥—å±‚çº§ï¼šåˆç†ï¼ˆæœ€æ·±4å±‚ï¼‰
â”œâ”€â”€ æ–¹æ³•é•¿åº¦ï¼šä¼˜ç§€ï¼ˆå¹³å‡20è¡Œï¼‰
â””â”€â”€ å¯ç»´æŠ¤æ€§ï¼šâ­â­â­â­â­
```

---

## 5. æ•°æ®æ¨¡å‹å±‚ï¼ˆModelï¼‰è¯¦è§£

### 5.1 HealthDataæ¨¡å‹æ·±åº¦è§£æ

#### 5.1.1 æ•°æ®ç»“æ„è®¾è®¡

```swift
struct HealthData {
    // åŸå§‹å¥åº·æ•°æ®
    var steps: Int = 0              // ä»Šæ—¥æ­¥æ•°
    var sleepHours: Double = 0      // æ˜¨æ™šç¡çœ æ—¶é•¿ï¼ˆå°æ—¶ï¼‰
    var exerciseMinutes: Int = 0    // è¿åŠ¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    var heartRate: Int = 70         // å¿ƒç‡ï¼ˆBPMï¼‰
    var goldCoins: Int = 0          // é‡‘å¸æ•°é‡
    
    // è®¡ç®—å±æ€§ï¼šè¯„åˆ†ç³»ç»Ÿ
    var stepsScore: Int { ... }     // æ­¥æ•°å¾—åˆ†ï¼ˆ0-100ï¼‰
    var sleepScore: Int { ... }     // ç¡çœ å¾—åˆ†ï¼ˆ0-100ï¼‰
    var exerciseScore: Int { ... }  // è¿åŠ¨å¾—åˆ†ï¼ˆ0-100ï¼‰
    var overallScore: Int { ... }   // ç»¼åˆå¾—åˆ†ï¼ˆ0-100ï¼‰
    
    // çŠ¶æ€åˆ¤æ–­
    var hasSleepDebuff: Bool { ... }    // æ˜¯å¦ç¡çœ ä¸è¶³
    var hasChestReward: Bool { ... }    // æ˜¯å¦è¾¾åˆ°å®ç®±æ¡ä»¶
    
    // ä¸šåŠ¡æ–¹æ³•
    mutating func updateGoldCoins()     // æ›´æ–°é‡‘å¸
}
```

#### 5.1.2 è¯„åˆ†ç®—æ³•è®¾è®¡

**1. æ­¥æ•°è¯„åˆ†ç®—æ³•**
```swift
var stepsScore: Int {
    min(100, steps / 100)
}

è®¾è®¡æ€è·¯ï¼š
- ç›®æ ‡ï¼š10,000æ­¥ä¸ºæ»¡åˆ†
- å…¬å¼ï¼šscore = min(100, steps Ã· 100)
- çº¿æ€§å…³ç³»ï¼šæ¯100æ­¥å¢åŠ 1åˆ†
- ä¸Šé™ä¿æŠ¤ï¼šæœ€é«˜100åˆ†

è¯„åˆ†åŒºé—´ï¼š
0æ­¥      â†’  0åˆ†   ï¼ˆæå·®ï¼‰
2,000æ­¥  â†’ 20åˆ†   ï¼ˆè¾ƒå·®ï¼‰
5,000æ­¥  â†’ 50åˆ†   ï¼ˆä¸€èˆ¬ï¼‰
8,000æ­¥  â†’ 80åˆ†   ï¼ˆè‰¯å¥½ï¼‰
10,000æ­¥ â†’ 100åˆ†  ï¼ˆä¼˜ç§€ï¼‰
15,000æ­¥ â†’ 100åˆ†  ï¼ˆä¸Šé™ï¼‰
```

**2. ç¡çœ è¯„åˆ†ç®—æ³•**
```swift
var sleepScore: Int {
    if sleepHours >= 8 { return 100 }    // å……è¶³
    if sleepHours >= 7 { return 80 }     // è‰¯å¥½
    if sleepHours >= 6 { return 60 }     // åŠæ ¼
    if sleepHours >= 5 { return 40 }     // ä¸è¶³
    if sleepHours >= 4 { return 20 }     // ä¸¥é‡ä¸è¶³
    return 0                              // æåº¦ç¼ºä¹
}

è®¾è®¡æ€è·¯ï¼š
- åŸºäºåŒ»å­¦å»ºè®®ï¼ˆæˆäºº7-9å°æ—¶ï¼‰
- åˆ†æ®µè¯„åˆ†ï¼Œéçº¿æ€§
- 8å°æ—¶æ»¡åˆ†
- ä½äº6å°æ—¶æ˜¾è‘—é™åˆ†

ç§‘å­¦ä¾æ®ï¼š
8+å°æ—¶  â†’ 100åˆ† ï¼ˆæœ€ä½³æ¢å¤ï¼‰
7-8å°æ—¶ â†’  80åˆ† ï¼ˆå……åˆ†ä¼‘æ¯ï¼‰
6-7å°æ—¶ â†’  60åˆ† ï¼ˆåŸºæœ¬æ»¡è¶³ï¼‰
5-6å°æ—¶ â†’  40åˆ† ï¼ˆå¼€å§‹å½±å“å¥åº·ï¼‰
4-5å°æ—¶ â†’  20åˆ† ï¼ˆä¸¥é‡å½±å“ï¼‰
<4å°æ—¶  â†’   0åˆ† ï¼ˆå±é™©åŒºåŸŸï¼‰
```

**3. è¿åŠ¨è¯„åˆ†ç®—æ³•**
```swift
var exerciseScore: Int {
    min(100, exerciseMinutes * 100 / 60)
}

è®¾è®¡æ€è·¯ï¼š
- ç›®æ ‡ï¼š60åˆ†é’Ÿä¸ºæ»¡åˆ†
- å…¬å¼ï¼šscore = min(100, minutes Ã— 100 Ã· 60)
- çº¿æ€§å…³ç³»ï¼šæ¯åˆ†é’Ÿçº¦1.67åˆ†
- ç¬¦åˆWHOå»ºè®®ï¼ˆæ¯å¤©30-60åˆ†é’Ÿï¼‰

è¯„åˆ†åŒºé—´ï¼š
0åˆ†é’Ÿ   â†’   0åˆ†  ï¼ˆæ— è¿åŠ¨ï¼‰
15åˆ†é’Ÿ  â†’  25åˆ†  ï¼ˆè½»åº¦ï¼‰
30åˆ†é’Ÿ  â†’  50åˆ†  ï¼ˆè¾¾æ ‡ï¼‰
45åˆ†é’Ÿ  â†’  75åˆ†  ï¼ˆè‰¯å¥½ï¼‰
60åˆ†é’Ÿ  â†’ 100åˆ†  ï¼ˆä¼˜ç§€ï¼‰
90åˆ†é’Ÿ  â†’ 100åˆ†  ï¼ˆä¸Šé™ï¼‰
```

**4. ç»¼åˆè¯„åˆ†ç®—æ³•**
```swift
var overallScore: Int {
    (stepsScore + sleepScore + exerciseScore) / 3
}

è®¾è®¡æ€è·¯ï¼š
- ä¸‰é¡¹å¹³å‡ï¼šå…¨é¢è¯„ä¼°å¥åº·çŠ¶å†µ
- æƒé‡ç›¸åŒï¼šæ¯é¡¹åŒç­‰é‡è¦
- èŒƒå›´ï¼š0-100åˆ†

å¥åº·ç­‰çº§æ˜ å°„ï¼š
 0-20åˆ† â†’ å±é™©ï¼ˆCriticalï¼‰    ğŸ”´
21-40åˆ† â†’ è™šå¼±ï¼ˆWeakï¼‰        ğŸŸ 
41-60åˆ† â†’ æ­£å¸¸ï¼ˆNormalï¼‰      ğŸŸ¡
61-80åˆ† â†’ è‰¯å¥½ï¼ˆGoodï¼‰        ğŸŸ¢
81-100åˆ† â†’ ä¼˜ç§€ï¼ˆExcellentï¼‰  ğŸ”µ
```

#### 5.1.3 é‡‘å¸è®¡ç®—é€»è¾‘

```swift
mutating func updateGoldCoins() {
    // åŸºç¡€é‡‘å¸ï¼šæ­¥æ•°å¥–åŠ±
    var coins = steps / 10
    
    // ç¡çœ å¥–åŠ±
    if sleepHours >= 8 {
        coins += 50      // å……è¶³ç¡çœ 
    } else if sleepHours >= 7 {
        coins += 30      // è‰¯å¥½ç¡çœ 
    } else if sleepHours >= 6 {
        coins += 10      // åŠæ ¼ç¡çœ 
    }
    
    // è¿åŠ¨å¥–åŠ±
    if exerciseMinutes >= 60 {
        coins += 50      // å……è¶³è¿åŠ¨
    } else if exerciseMinutes >= 30 {
        coins += 30      // è‰¯å¥½è¿åŠ¨
    } else if exerciseMinutes >= 15 {
        coins += 10      // åŸºç¡€è¿åŠ¨
    }
    
    goldCoins = coins
}

è®¾è®¡äº®ç‚¹ï¼š
âœ“ å¤šç»´åº¦æ¿€åŠ±ï¼šé¼“åŠ±å…¨é¢å¥åº·
âœ“ é˜¶æ¢¯å¥–åŠ±ï¼šè¾¾åˆ°ç›®æ ‡æœ‰æ˜æ˜¾æ”¶ç›Š
âœ“ å¹³è¡¡æ€§ï¼šæ¯å¤©æœ€é«˜~1100é‡‘å¸

ç¤ºä¾‹è®¡ç®—ï¼š
å®Œç¾ä¸€å¤©ï¼š
- 10,000æ­¥ = 1000é‡‘å¸
- 8å°æ—¶ç¡çœ  = +50é‡‘å¸
- 60åˆ†é’Ÿè¿åŠ¨ = +50é‡‘å¸
- æ€»è®¡ï¼š1100é‡‘å¸

æ™®é€šä¸€å¤©ï¼š
- 6,000æ­¥ = 600é‡‘å¸
- 7å°æ—¶ç¡çœ  = +30é‡‘å¸
- 30åˆ†é’Ÿè¿åŠ¨ = +30é‡‘å¸
- æ€»è®¡ï¼š660é‡‘å¸

æ‡’æƒ°ä¸€å¤©ï¼š
- 2,000æ­¥ = 200é‡‘å¸
- 5å°æ—¶ç¡çœ  = 0é‡‘å¸
- 0åˆ†é’Ÿè¿åŠ¨ = 0é‡‘å¸
- æ€»è®¡ï¼š200é‡‘å¸
```

### 5.2 HealthHistoryæ¨¡å‹è¯¦è§£

HealthHistoryæ¨¡å‹è´Ÿè´£ç®¡ç†ç”¨æˆ·çš„å¥åº·æ•°æ®å†å²è®°å½•ï¼Œæä¾›è¶‹åŠ¿åˆ†æå’Œæ•°æ®å¯è§†åŒ–æ”¯æŒã€‚è¯¥æ¨¡å‹åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼š

**DailyHealthRecordæ¯æ—¥è®°å½•ç»“æ„**å°è£…äº†å•æ—¥çš„æ‰€æœ‰å¥åº·æ•°æ®ï¼ŒåŒ…æ‹¬æ—¥æœŸã€æ­¥æ•°ã€ç¡çœ æ—¶é•¿ã€è¿åŠ¨åˆ†é’Ÿæ•°å’Œç»¼åˆå¥åº·åˆ†æ•°ã€‚æ¯æ¡è®°å½•éƒ½æœ‰å”¯ä¸€çš„UUIDæ ‡è¯†ç¬¦ï¼Œéµå¾ªCodableåè®®ä»¥æ”¯æŒæŒä¹…åŒ–å­˜å‚¨ã€‚

**HealthHistoryManagerå†å²ç®¡ç†å™¨**é‡‡ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†å…¨å±€å†å²æ•°æ®ï¼Œç»´æŠ¤ä¸€ä¸ªDailyHealthRecordæ•°ç»„ï¼Œé™åˆ¶æœ€å¤šä¿å­˜90å¤©çš„è®°å½•ä»¥æ§åˆ¶å†…å­˜å ç”¨ã€‚å½“æ¥æ”¶åˆ°æ–°çš„å¥åº·æ•°æ®æ—¶ï¼Œç®¡ç†å™¨ä¼šå…ˆç§»é™¤å½“å¤©çš„æ—§è®°å½•ï¼Œé¿å…é‡å¤ï¼Œç„¶åæ·»åŠ æ–°è®°å½•å¹¶è‡ªåŠ¨è¿›è¡ŒæŒä¹…åŒ–ã€‚ç®¡ç†å™¨æä¾›äº†è·å–æœ€è¿‘Nå¤©è®°å½•çš„æ–¹æ³•ï¼Œæ”¯æŒ7å¤©ã€14å¤©ã€30å¤©æˆ–90å¤©çš„æ•°æ®æŸ¥è¯¢ã€‚

**HealthHistoryAnalysisåˆ†æç»“æœ**ç»“æ„ä½“å°è£…äº†å¯¹å†å²æ•°æ®çš„ç»Ÿè®¡åˆ†æç»“æœï¼ŒåŒ…æ‹¬å„é¡¹æŒ‡æ ‡çš„å¹³å‡å€¼ï¼ˆå¹³å‡æ­¥æ•°ã€å¹³å‡ç¡çœ ã€å¹³å‡è¿åŠ¨ã€å¹³å‡åˆ†æ•°ï¼‰å’Œè¶‹åŠ¿åˆ¤æ–­ï¼ˆä¸Šå‡ã€ä¸‹é™ã€ç¨³å®šï¼‰ã€‚ç³»ç»Ÿè¿˜ä¼šæ£€æµ‹å¼‚å¸¸æƒ…å†µï¼Œå¦‚è¿ç»­å¤šå¤©ç¡çœ ä¸è¶³æˆ–è¿åŠ¨ä¸è¶³ï¼ŒåŠæ—¶æé†’ç”¨æˆ·æ³¨æ„ã€‚

è¶‹åŠ¿è®¡ç®—é‡‡ç”¨ç®€å•çº¿æ€§å›å½’çš„æ€æƒ³ï¼Œæ¯”è¾ƒå‰åŠæ®µå’ŒååŠæ®µæ•°æ®çš„å¹³å‡å€¼ã€‚å¦‚æœååŠæ®µæ˜æ˜¾é«˜äºå‰åŠæ®µï¼Œåˆ¤å®šä¸ºä¸Šå‡è¶‹åŠ¿ï¼›å¦‚æœæ˜¾è‘—ä½äºï¼Œåˆ¤å®šä¸ºä¸‹é™è¶‹åŠ¿ï¼›å·®å¼‚ä¸å¤§æ—¶ä¸ºç¨³å®šè¶‹åŠ¿ã€‚è¿™ç§æ–¹æ³•ç®€å•æœ‰æ•ˆï¼Œèƒ½å¤Ÿç›´è§‚åœ°åæ˜ ç”¨æˆ·å¥åº·çŠ¶å†µçš„å˜åŒ–æ–¹å‘ã€‚
        )
        
        // è®¡ç®—è¿ç»­å¼‚å¸¸å¤©æ•°
        let consecutiveLowSleep = countConsecutive(
            recentRecords.reversed(),
            condition: { $0.sleepHours < 6 }
        )
        let consecutiveLowExercise = countConsecutive(
            recentRecords.reversed(),
            condition: { $0.exerciseMinutes < 15 }
        )
        
        return HealthHistoryAnalysis(
            averageSteps: avgSteps,
            averageSleep: avgSleep,
            averageExercise: avgExercise,
            averageScore: avgScore,
            stepsTrend: stepsTrend,
            sleepTrend: sleepTrend,
            exerciseTrend: exerciseTrend,
            consecutiveLowSleep: consecutiveLowSleep,
            consecutiveLowExercise: consecutiveLowExercise
        )
    }
}
```

#### 5.2.3 è¶‹åŠ¿è®¡ç®—ç®—æ³•

```swift
private func calculateTrend(_ values: [Int]) -> HealthTrend {
    guard values.count >= 3 else { return .stable }
    
    // å–æœ€è¿‘3å¤©å’Œä¹‹å‰çš„æ•°æ®æ¯”è¾ƒ
    let recent = Array(values.suffix(3))
    let previous = Array(values.dropLast(3).suffix(3))
    
    guard !previous.isEmpty else { return .stable }
    
    let recentAvg = Double(recent.reduce(0, +)) / Double(recent.count)
    let previousAvg = Double(previous.reduce(0, +)) / Double(previous.count)
    
    let change = (recentAvg - previousAvg) / previousAvg
    
    // å˜åŒ–è¶…è¿‡10%æ‰ç®—è¶‹åŠ¿
    if change > 0.1 {
        return .improving
    } else if change < -0.1 {
        return .declining
    } else {
        return .stable
    }
}

ç®—æ³•è¯´æ˜ï¼š
1. æœ€è¿‘3å¤©å¹³å‡å€¼ vs ä¹‹å‰3å¤©å¹³å‡å€¼
2. è®¡ç®—å˜åŒ–ç‡
3. Â±10%ä½œä¸ºé˜ˆå€¼
4. é¿å…å™ªå£°å¹²æ‰°

ç¤ºä¾‹ï¼š
[5000, 6000, 7000] vs [8000, 9000, 10000]
recent avg = 8667, previous avg = 6000
change = (8667-6000)/6000 = 44.4%
ç»“æœï¼šimproving â†—ï¸
```

#### 5.2.4 æ•°æ®æŒä¹…åŒ–

```swift
private func saveRecords() {
    if let encoded = try? JSONEncoder().encode(records) {
        UserDefaults.standard.set(
            encoded,
            forKey: "healthHistoryRecords"
        )
    }
}

private func loadRecords() {
    if let data = UserDefaults.standard.data(
        forKey: "healthHistoryRecords"
    ),
       let decoded = try? JSONDecoder().decode(
        [DailyHealthRecord].self,
        from: data
       ) {
        records = decoded
    }
}

æŠ€æœ¯è¦ç‚¹ï¼š
âœ“ Codableåè®®è‡ªåŠ¨åºåˆ—åŒ–
âœ“ UserDefaultsè½»é‡çº§å­˜å‚¨
âœ“ å¼‚æ­¥æ“ä½œé¿å…é˜»å¡
âœ“ é”™è¯¯å¤„ç†ä¿è¯ç¨³å®šæ€§
```

### 5.3 å…¶ä»–æ ¸å¿ƒModel

**CharacterTypeï¼ˆè§’è‰²ç±»å‹ï¼‰**
- å®šä¹‰4ç§è§’è‰²ï¼šæˆ˜å£«ã€æ³•å¸ˆã€å® ç‰©ã€æ™ºè€…
- æ¯ç§è§’è‰²æœ‰ä¸åŒä¸»é¢˜è‰²ã€å¯¹è¯é£æ ¼ã€è¡¨æƒ…ç³»ç»Ÿ
- æ ¹æ®å¥åº·ç­‰çº§åŠ¨æ€å˜åŒ–è¡¨æƒ…ï¼ˆå±é™©ã€è™šå¼±ã€æ­£å¸¸ã€è‰¯å¥½ã€ä¼˜ç§€ï¼‰

**ImageCharacterï¼ˆå›¾ç‰‡è§’è‰²ï¼‰**
- 6ä¸ªå¯è§£é”è§’è‰²ï¼Œè§£é”æˆæœ¬500-1500é‡‘å¸
- æ”¯æŒå¤šç§é£æ ¼ï¼šåŠ¨æ¼«ã€Qç‰ˆã€åƒç´ ã€å†™å®
- å›¾ç‰‡èµ„æºæ ¹æ®å¥åº·ç­‰çº§åˆ‡æ¢
- æŒä¹…åŒ–å­˜å‚¨è§£é”çŠ¶æ€

---

## 6. è§†å›¾æ¨¡å‹å±‚ï¼ˆViewModelï¼‰è¯¦è§£

### 6.1 MVVMä¸­ViewModelçš„èŒè´£

ViewModelæ˜¯MVVMæ¶æ„çš„æ ¸å¿ƒï¼Œæ‰¿æ‹…ä»¥ä¸‹èŒè´£ï¼š
- **ä¸šåŠ¡é€»è¾‘å¤„ç†**ï¼šå°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ä»Viewä¸­åˆ†ç¦»
- **æ•°æ®è½¬æ¢**ï¼šå°†Modelçš„æ•°æ®è½¬æ¢ä¸ºViewå¯ç›´æ¥ä½¿ç”¨çš„æ ¼å¼
- **çŠ¶æ€ç®¡ç†**ï¼šç®¡ç†åº”ç”¨çš„å„ç§çŠ¶æ€ï¼ˆåŠ è½½ä¸­ã€é”™è¯¯ã€æˆåŠŸç­‰ï¼‰
- **äº‹ä»¶å“åº”**ï¼šå“åº”ç”¨æˆ·æ“ä½œå¹¶åè°ƒModelå’ŒViewçš„äº¤äº’

### 6.2 GameStateManagerï¼ˆæ¸¸æˆçŠ¶æ€ç®¡ç†å™¨ï¼‰

#### 6.2.1 æ ¸å¿ƒèŒè´£

```swift
class GameStateManager: ObservableObject {
    @Published var partnerAttributes: PartnerAttributes
    @Published var healthHistory: HealthHistoryManager
    @Published var showChestAnimation = false
    @Published var showLevelUpAnimation = false
    @Published var dailyDialogue: String?
    
    // æ ¸å¿ƒåŠŸèƒ½
    func updateWithNewHealthData(_ healthData: HealthData)
    func checkDailyRewards()
    func generateDialogue(for characterType: CharacterType, healthData: HealthData)
}
```

#### 6.2.2 ä¸»è¦åŠŸèƒ½

**1. å¥åº·æ•°æ®åŒæ­¥**
- æ¥æ”¶HealthStoreManagerä¼ æ¥çš„å¥åº·æ•°æ®
- æ›´æ–°ä¼™ä¼´çŠ¶æ€ï¼ˆHPã€ç»éªŒå€¼ï¼‰
- è®°å½•å†å²æ•°æ®
- è®¡ç®—é‡‘å¸å¥–åŠ±

**2. åŠ¨ç”»è§¦å‘**
- å¥åº·ç­‰çº§æå‡è§¦å‘å‡çº§åŠ¨ç”»
- è¾¾æˆç›®æ ‡è§¦å‘å®ç®±åŠ¨ç”»
- è§£é”æ–°è§’è‰²è§¦å‘ç‰¹æ•ˆ

**3. å¯¹è¯ç”Ÿæˆ**
- è°ƒç”¨AIServiceç”Ÿæˆä¸ªæ€§åŒ–å¯¹è¯
- ç¼“å­˜å¯¹è¯é¿å…é‡å¤è¯·æ±‚
- æ ¹æ®å¥åº·çŠ¶æ€è°ƒæ•´å¯¹è¯å†…å®¹

**4. å¥–åŠ±ç³»ç»Ÿ**
- æ¯æ—¥é¦–æ¬¡è¾¾æ ‡å¥–åŠ±50é‡‘å¸
- è¿ç»­è¾¾æ ‡å¥–åŠ±é€’å¢
- å‘¨æœŸæ€§æˆå°±æ£€æµ‹

### 6.3 HealthStoreManagerï¼ˆå¥åº·æ•°æ®ç®¡ç†å™¨ï¼‰

#### 6.3.1 æ ¸å¿ƒèŒè´£

```swift
class HealthStoreManager: ObservableObject {
    @Published var healthData: HealthData = HealthData()
    private let healthStore = HKHealthStore()
    
    // æ ¸å¿ƒåŠŸèƒ½
    func requestAuthorization() async throws
    func fetchTodayHealthData() async
    func startObservingHealthData()
}
```

#### 6.3.2 ä¸»è¦åŠŸèƒ½

**1. æƒé™ç®¡ç†**
- è¯·æ±‚HealthKitè¯»å–æƒé™ï¼ˆæ­¥æ•°ã€ç¡çœ ã€è¿åŠ¨ã€å¿ƒç‡ï¼‰
- å¤„ç†æƒé™è¢«æ‹’çš„æƒ…å†µ
- å¼•å¯¼ç”¨æˆ·æˆæƒ

**2. æ•°æ®è·å–**
```swift
è·å–ä»Šæ—¥æ•°æ®æµç¨‹ï¼š
1. ç¡®å®šæ—¶é—´èŒƒå›´ï¼ˆå‡Œæ™¨0ç‚¹åˆ°ç°åœ¨ï¼‰
2. å¹¶å‘æŸ¥è¯¢å¤šç§å¥åº·æ•°æ®
   - æ­¥æ•°ï¼šHKQuantityType(.stepCount)
   - ç¡çœ ï¼šHKCategoryType(.sleepAnalysis)
   - è¿åŠ¨ï¼šHKQuantityType(.appleExerciseTime)
   - å¿ƒç‡ï¼šHKQuantityType(.heartRate)
3. å¤„ç†æŸ¥è¯¢ç»“æœå¹¶èšåˆ
4. æ›´æ–°healthDataæ¨¡å‹
5. é€šçŸ¥GameStateManageræ›´æ–°æ¸¸æˆçŠ¶æ€
```

**3. å®æ—¶ç›‘å¬**
- ä½¿ç”¨HKObserverQueryç›‘å¬æ•°æ®å˜åŒ–
- æ­¥æ•°å˜åŒ–ç«‹å³æ›´æ–°UI
- åå°æ›´æ–°æ”¯æŒ

**4. æ•°æ®æŒä¹…åŒ–**
- å®šæœŸä¿å­˜å¥åº·æ•°æ®åˆ°UserDefaults
- æ¢å¤ä¸Šæ¬¡æ•°æ®é¿å…ä¸¢å¤±
- æ¸…ç†è¿‡æœŸæ•°æ®

### 6.4 ViewModelä¹‹é—´çš„åä½œ

```
ç”¨æˆ·æ‰“å¼€App
    â†“
HealthStoreManagerè¯·æ±‚æƒé™
    â†“
åå°æŸ¥è¯¢HealthKitæ•°æ®
    â†“
æ›´æ–°healthDataï¼ˆ@Publishedï¼‰
    â†“
GameStateManagerç›‘å¬åˆ°æ•°æ®å˜åŒ–
    â†“
è®¡ç®—é‡‘å¸å¥–åŠ±ã€æ›´æ–°ä¼™ä¼´çŠ¶æ€
    â†“
è°ƒç”¨AIServiceç”Ÿæˆå¯¹è¯
    â†“
æ›´æ–°æ¸¸æˆçŠ¶æ€ï¼ˆ@Publishedï¼‰
    â†“
Viewè‡ªåŠ¨åˆ·æ–°UI
```

### 6.5 Combineæ¡†æ¶çš„åº”ç”¨

**@Publishedå±æ€§åŒ…è£…å™¨**
```swift
@Published var healthData: HealthData = HealthData()

// ç­‰ä»·äºï¼š
private var _healthData: HealthData = HealthData()
var healthDataPublisher: Published<HealthData>.Publisher { $_healthData }
```

**æ•°æ®æµç¤ºä¾‹**
```swift
healthManager.$healthData
    .debounce(for: .seconds(1), scheduler: DispatchQueue.main)  // é˜²æŠ–
    .sink { newData in
        gameState.updateWithNewHealthData(newData)  // æ›´æ–°æ¸¸æˆçŠ¶æ€
    }
    .store(in: &cancellables)
```

---

## 7. è§†å›¾å±‚ï¼ˆViewï¼‰è¯¦è§£

### 7.1 SwiftUIæ ¸å¿ƒæ¦‚å¿µ

**å£°æ˜å¼UI**ï¼šç›´æ¥æè¿°UIåº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­ï¼Œè€Œä¸æ˜¯å¦‚ä½•å˜æˆé‚£æ ·
**æ•°æ®é©±åŠ¨**ï¼šæ•°æ®å˜åŒ–è‡ªåŠ¨è§¦å‘UIæ›´æ–°
**ç»„åˆå¼æ¶æ„**ï¼šé€šè¿‡ç»„åˆå°ç»„ä»¶æ„å»ºå¤æ‚ç•Œé¢

### 7.2 ä¸»è¦è§†å›¾ç»„ä»¶

#### 7.2.1 ContentViewï¼ˆä¸»ç•Œé¢ï¼‰

```
ç»“æ„å±‚æ¬¡ï¼š
ZStack
â”œâ”€â”€ èƒŒæ™¯æ¸å˜
â”œâ”€â”€ VStackï¼ˆä¸»å†…å®¹ï¼‰
â”‚   â”œâ”€â”€ TopStatusBarï¼ˆé¡¶éƒ¨æ ï¼‰
â”‚   â”‚   â”œâ”€â”€ é‡‘å¸æ˜¾ç¤ºButton
â”‚   â”‚   â”œâ”€â”€ å†å²è®°å½•Button
â”‚   â”‚   â”œâ”€â”€ èŠå¤©Button
â”‚   â”‚   â”œâ”€â”€ è®¾ç½®Buttonï¼ˆé•¿æŒ‰2ç§’å¼€å¯è°ƒè¯•ï¼‰
â”‚   â”‚   â””â”€â”€ è§’è‰²åˆ‡æ¢Button
â”‚   â”œâ”€â”€ DynamicCharacterViewï¼ˆè§’è‰²å±•ç¤ºï¼‰
â”‚   â”‚   â”œâ”€â”€ å¾„å‘æ¸å˜å…‰ç¯
â”‚   â”‚   â”œâ”€â”€ è§’è‰²Emoji/å›¾ç‰‡
â”‚   â”‚   â””â”€â”€ çŠ¶æ€ç‰¹æ•ˆ
â”‚   â”œâ”€â”€ DialogueBubbleViewï¼ˆå¯¹è¯æ°”æ³¡ï¼‰
â”‚   â””â”€â”€ HealthInfoCardï¼ˆå¥åº·ä¿¡æ¯å¡ç‰‡ï¼‰
â”‚       â”œâ”€â”€ å¥åº·æŒ‡æ•°ï¼ˆå¤§å­—å·+é˜´å½±ï¼‰
â”‚       â””â”€â”€ æ•°æ®ç½‘æ ¼ï¼ˆæ­¥æ•°ã€ç¡çœ ã€è¿åŠ¨ï¼‰
â””â”€â”€ åŠ¨ç”»è¦†ç›–å±‚
    â”œâ”€â”€ RewardAnimationView
    â””â”€â”€ LevelUpAnimationView
```

**æ•°æ®ç»‘å®šç¤ºä¾‹**
```swift
@EnvironmentObject var healthManager: HealthStoreManager
@EnvironmentObject var gameState: GameStateManager

Text("\(healthManager.healthData.overallScore)")  // è‡ªåŠ¨æ›´æ–°
```

#### 7.2.2 ChatViewï¼ˆèŠå¤©ç•Œé¢ï¼‰

**åŠŸèƒ½ç‰¹ç‚¹**
- ScrollViewReaderå®ç°è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
- LazyVStackå»¶è¿ŸåŠ è½½æå‡æ€§èƒ½
- Task/async-awaitå¼‚æ­¥è°ƒç”¨AIæ¥å£
- MainActorç¡®ä¿UIæ›´æ–°åœ¨ä¸»çº¿ç¨‹

**äº¤äº’æµç¨‹**
```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
    â†“
æ·»åŠ åˆ°messagesæ•°ç»„ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰
    â†“
è°ƒç”¨AIService.chat()
    â†“
ç­‰å¾…AIå“åº”ï¼ˆæ˜¾ç¤ºloadingï¼‰
    â†“
æ¥æ”¶å“åº”æ·»åŠ åˆ°messagesï¼ˆAIæ¶ˆæ¯ï¼‰
    â†“
è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
```

#### 7.2.3 HealthHistoryViewï¼ˆå¥åº·å†å²ï¼‰

**æ•°æ®å±•ç¤º**
- æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ï¼ˆ7/14/30/90å¤©ï¼‰
- å¹³å‡æ•°æ®æ¦‚è§ˆå¡ç‰‡
- è¯¦ç»†æ•°æ®åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰
- è¶‹åŠ¿åˆ†æå›¾è¡¨
- AIç”Ÿæˆçš„å¥åº·æŠ¥å‘Š

**æ•°æ®è·å–æµç¨‹**
```swift
Viewå‡ºç°
    â†“
ä»GameStateManagerè·å–HealthHistoryManager
    â†“
è°ƒç”¨getRecentRecords(days: 7)
    â†“
è°ƒç”¨analyzeRecent(days: 7)è·å–ç»Ÿè®¡æ•°æ®
    â†“
å¼‚æ­¥è°ƒç”¨AIç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Š
    â†“
æ˜¾ç¤ºæ•°æ®å’Œåˆ†æç»“æœ
```

---

## 8. æœåŠ¡å±‚ï¼ˆServiceï¼‰è¯¦è§£

### 8.1 AIServiceï¼ˆAIå¯¹è¯æœåŠ¡ï¼‰

#### 8.1.1 æ ¸å¿ƒåŠŸèƒ½

**1. è§’è‰²å¯¹è¯ç”Ÿæˆ**
```swift
func chat(
    userMessage: String,
    characterType: CharacterType,
    healthData: HealthData
) async throws -> String
```

- æ ¹æ®è§’è‰²ç±»å‹æ„å»ºä¸åŒçš„system prompt
- ç»“åˆå¥åº·æ•°æ®ç”Ÿæˆä¸ªæ€§åŒ–å›å¤
- æ”¯æŒå¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡

**2. æ¯æ—¥é—®å€™ç”Ÿæˆ**
- åˆ†æå½“å¤©å¥åº·æ•°æ®
- ç”Ÿæˆé¼“åŠ±æˆ–æé†’çš„å¯¹è¯
- ç¼“å­˜å½“å¤©å¯¹è¯é¿å…é‡å¤ç”Ÿæˆ

**3. å¥åº·åˆ†ææŠ¥å‘Š**
- åˆ†æ7/14/30å¤©å¥åº·è¶‹åŠ¿
- ç”Ÿæˆä¸“ä¸šçš„å¥åº·å»ºè®®
- Markdownæ ¼å¼è¿”å›

#### 8.1.2 APIé›†æˆ

**SiliconFlow API**
- æ¨¡å‹ï¼šQwen/Qwen2.5-7B-Instruct
- ç«¯ç‚¹ï¼šhttps://api.siliconflow.cn/v1/chat/completions
- è®¤è¯ï¼šBearer Token

**è¯·æ±‚æ ¼å¼**
```json
{
  "model": "Qwen/Qwen2.5-7B-Instruct",
  "messages": [
    {"role": "system", "content": "è§’è‰²è®¾å®š..."},
    {"role": "user", "content": "ç”¨æˆ·æ¶ˆæ¯..."}
  ],
  "temperature": 0.7,
  "max_tokens": 500
}
```

#### 8.1.3 é”™è¯¯å¤„ç†

- ç½‘ç»œè¶…æ—¶ï¼šæ˜¾ç¤ºå‹å¥½æç¤º
- APIé™æµï¼šå®ç°é‡è¯•æœºåˆ¶
- è§£æé”™è¯¯ï¼šè¿”å›é»˜è®¤å›å¤
- æ— ç½‘ç»œï¼šæç¤ºæ£€æŸ¥ç½‘ç»œè¿æ¥

### 8.2 WidgetDataManagerï¼ˆå°ç»„ä»¶æ•°æ®ç®¡ç†ï¼‰

**åŠŸèƒ½**
- ä½¿ç”¨App Groupså…±äº«æ•°æ®ç»™Widget
- å°†å¥åº·æ•°æ®ç¼–ç ä¸ºJSON
- Widget Extensionè¯»å–å¹¶æ˜¾ç¤º

**æ•°æ®æµ**
```
Appæ›´æ–°å¥åº·æ•°æ®
    â†“
WidgetDataManager.saveHealthData()
    â†“
å†™å…¥App Groupå…±äº«å®¹å™¨
    â†“
WidgetCenter.shared.reloadAllTimelines()
    â†“
Widgetè¯»å–æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
```

---

## 9. æ•°æ®æµä¸çŠ¶æ€ç®¡ç†

### 9.1 å•å‘æ•°æ®æµ

```
æ•°æ®æºï¼ˆModelï¼‰
    â†“
ViewModelå¤„ç†å’Œè½¬æ¢
    â†“
@Publishedå‘å¸ƒå˜åŒ–
    â†“
Viewè®¢é˜…å¹¶æ›´æ–°UI
    â†“
ç”¨æˆ·äº¤äº’è§¦å‘äº‹ä»¶
    â†“
ViewModelå¤„ç†ä¸šåŠ¡é€»è¾‘
    â†“
æ›´æ–°Modelæ•°æ®
    â†“
å¾ªç¯å¼€å§‹
```

### 9.2 ä¾èµ–æ³¨å…¥

**EnvironmentObject**
```swift
@main
struct VitalityPactApp: App {
    @StateObject private var healthManager = HealthStoreManager()
    @StateObject private var gameState = GameStateManager()
    
    var body: some Scene {
        WindowGroup {
            ContentView()
                .environmentObject(healthManager)
                .environmentObject(gameState)
        }
    }
}
```

å¥½å¤„ï¼š
- é¿å…å±æ€§ä¼ é€’é“¾
- è§£è€¦ç»„ä»¶ä¾èµ–
- æ˜“äºæµ‹è¯•å’Œæ›¿æ¢

### 9.3 çŠ¶æ€æŒä¹…åŒ–

**UserDefaults**
- å¥åº·æ•°æ®
- é‡‘å¸æ•°é‡
- è§£é”çš„è§’è‰²
- ç”¨æˆ·è®¾ç½®

**å¥åº·å†å²ï¼ˆCodable + JSONï¼‰**
```swift
let records: [DailyHealthRecord]
let data = try JSONEncoder().encode(records)
UserDefaults.standard.set(data, forKey: "healthHistory")
```

---

## 10. æ ¸å¿ƒåŠŸèƒ½å®ç°

### 10.1 å¥åº·æ•°æ®è¿½è¸ª

**HealthKité›†æˆæµç¨‹**
1. Info.plisté…ç½®æƒé™æè¿°
2. è¯·æ±‚ç”¨æˆ·æˆæƒ
3. å®šä¹‰æŸ¥è¯¢è°“è¯ï¼ˆæ—¶é—´èŒƒå›´ï¼‰
4. æ‰§è¡Œç»Ÿè®¡æŸ¥è¯¢
5. å¤„ç†ç»“æœå¹¶æ›´æ–°UI
6. è®¾ç½®åå°è§‚å¯Ÿè€…

### 10.2 é‡‘å¸ç³»ç»Ÿ

**è·å–è§„åˆ™**
- æ­¥æ•°ï¼šæ¯10æ­¥ = 1é‡‘å¸
- ç¡çœ ï¼šâ‰¥8å°æ—¶ +50é‡‘å¸
- è¿åŠ¨ï¼šâ‰¥60åˆ†é’Ÿ +50é‡‘å¸

**æ¶ˆè´¹åœºæ™¯**
- è§£é”æ–°è§’è‰²ï¼š500-1500é‡‘å¸
- æœªæ¥å¯æ‰©å±•ï¼šè´­ä¹°é“å…·ã€è£…æ‰®ç­‰

### 10.3 è§’è‰²è§£é”ç³»ç»Ÿ

**è§£é”æµç¨‹**
```
ç”¨æˆ·ç‚¹å‡»é”å®šè§’è‰²
    â†“
æ£€æŸ¥é‡‘å¸æ˜¯å¦è¶³å¤Ÿ
    â†“
è¶³å¤Ÿï¼šæ‰£é™¤é‡‘å¸å¹¶è§£é”
    â†“
ä¿å­˜è§£é”çŠ¶æ€
    â†“
åˆ·æ–°UIæ˜¾ç¤ºæ–°è§’è‰²
```

### 10.4 AIå¯¹è¯ç³»ç»Ÿ

**System Promptè®¾è®¡**
```
æˆ˜å£«ï¼šå……æ»¡æ¿€æƒ…ï¼Œä½¿ç”¨åŠ±å¿—è¯­è¨€ï¼Œé¼“åŠ±ç”¨æˆ·æŒ‘æˆ˜æé™
æ³•å¸ˆï¼šç†æ€§åˆ†æï¼Œç”¨æ•°æ®è¯´è¯ï¼Œæä¾›ç§‘å­¦å»ºè®®
å® ç‰©ï¼šæ¸©æš–æ²»æ„ˆï¼Œå…³å¿ƒç”¨æˆ·æ„Ÿå—ï¼Œé™ªä¼´å¼å¯¹è¯
æ™ºè€…ï¼šåšå­¦ç¿æ™ºï¼Œå¼•ç»æ®å…¸ï¼Œç»™å‡ºæ·±åº¦å»ºè®®
```

**ä¸Šä¸‹æ–‡ç®¡ç†**
- ä¿ç•™æœ€è¿‘5è½®å¯¹è¯
- æ¯æ¬¡è¯·æ±‚é™„å¸¦å¥åº·æ•°æ®
- æ ¹æ®æ—¶é—´æ®µè°ƒæ•´toneï¼ˆæ—©ä¸­æ™šï¼‰

---

## 11. è®¾è®¡æ¨¡å¼åº”ç”¨

### 11.1 è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserverï¼‰

**Combine + @Published**
```swift
class HealthStoreManager: ObservableObject {
    @Published var healthData: HealthData
    // æ•°æ®å˜åŒ–è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…
}
```

### 11.2 å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰

```swift
class AIService {
    static let shared = AIService()
    private init() {}  // é˜²æ­¢å¤–éƒ¨åˆ›å»ºå®ä¾‹
}
```

### 11.3 å·¥å‚æ¨¡å¼ï¼ˆFactoryï¼‰

```swift
static var allCharacters: [ImageCharacter] {
    return [
        createFoxCharacter(),
        createPixelHeroCharacter(),
        createBearCharacter(),
        // ...
    ]
}
```

### 11.4 ç­–ç•¥æ¨¡å¼ï¼ˆStrategyï¼‰

ä¸åŒè§’è‰²ç±»å‹å¯¹åº”ä¸åŒçš„å¯¹è¯ç”Ÿæˆç­–ç•¥ï¼š
```swift
func generatePrompt(for characterType: CharacterType) -> String {
    switch characterType {
    case .warrior: return warriorPrompt
    case .mage: return magePrompt
    case .pet: return petPrompt
    case .sage: return sagePrompt
    }
}
```

---

## 12. æ€§èƒ½ä¼˜åŒ–

### 12.1 UIæ¸²æŸ“ä¼˜åŒ–

- **LazyVStack/LazyHStack**ï¼šå»¶è¿ŸåŠ è½½åˆ—è¡¨é¡¹
- **@StateObject vs @ObservedObject**ï¼šé¿å…ä¸å¿…è¦çš„é‡å»º
- **GeometryReaderæœ€å°åŒ–ä½¿ç”¨**ï¼šå‡å°‘å¸ƒå±€è®¡ç®—

### 12.2 æ•°æ®æŸ¥è¯¢ä¼˜åŒ–

- **å¹¶å‘æŸ¥è¯¢**ï¼šä½¿ç”¨async letåŒæ—¶æŸ¥è¯¢å¤šç§æ•°æ®
- **æŸ¥è¯¢ç»“æœç¼“å­˜**ï¼šé¿å…é‡å¤æŸ¥è¯¢
- **åå°çº¿ç¨‹å¤„ç†**ï¼šå¤§é‡æ•°æ®å¤„ç†ä¸é˜»å¡UI

### 12.3 å†…å­˜ç®¡ç†

- **å¼±å¼•ç”¨é¿å…å¾ªç¯å¼•ç”¨**ï¼š[weak self]
- **å›¾ç‰‡èµ„æºä¼˜åŒ–**ï¼šä½¿ç”¨åˆé€‚å°ºå¯¸
- **å®šæ—¶æ¸…ç†è¿‡æœŸæ•°æ®**ï¼šä¿ç•™æœ€è¿‘90å¤©

---

## 13. é¡¹ç›®äº®ç‚¹ä¸åˆ›æ–°

### 13.1 MVVMæ¶æ„çš„å®Œæ•´åº”ç”¨

- Modelå±‚çº¯ç²¹çš„æ•°æ®ç»“æ„
- ViewModelå®Œå…¨åˆ†ç¦»ä¸šåŠ¡é€»è¾‘
- Viewåªè´Ÿè´£UIå±•ç¤ºå’Œç”¨æˆ·äº¤äº’
- Combineå®ç°å“åº”å¼ç¼–ç¨‹

### 13.2 æ¸¸æˆåŒ–å¥åº·ç®¡ç†

- è™šæ‹Ÿä¼™ä¼´é™ªä¼´æœºåˆ¶
- é‡‘å¸å¥–åŠ±ç³»ç»Ÿ
- è§’è‰²æ”¶é›†å…»æˆ
- å¥åº·ç­‰çº§å¯è§†åŒ–

### 13.3 AIæ·±åº¦é›†æˆ

- ä¸ªæ€§åŒ–å¯¹è¯ç”Ÿæˆ
- å¤šè§’è‰²æ€§æ ¼æ¨¡æ‹Ÿ
- å¥åº·è¶‹åŠ¿åˆ†æ
- æ™ºèƒ½å»ºè®®æ¨è

### 13.4 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- æµç•…çš„åŠ¨ç”»æ•ˆæœ
- æ¸…æ™°çš„ä¿¡æ¯æ¶æ„
- å‹å¥½çš„äº¤äº’åé¦ˆ
- æ— éšœç¢è®¾è®¡è€ƒè™‘

---

## 14. æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

---

## 14. æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### 14.1 HealthKitå¼‚æ­¥æŸ¥è¯¢

**éš¾ç‚¹**ï¼šå¤šä¸ªå¥åº·æ•°æ®éœ€è¦å¹¶å‘æŸ¥è¯¢ï¼Œä½†åˆè¦ç­‰å¾…æ‰€æœ‰ç»“æœ
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨async letå¹¶å‘æŸ¥è¯¢
```swift
async let steps = querySteps()
async let sleep = querySleep()
async let exercise = queryExercise()
let (stepsValue, sleepValue, exerciseValue) = await (steps, sleep, exercise)
```

### 14.2 SwiftUIçŠ¶æ€æ›´æ–°

**éš¾ç‚¹**ï¼šåå°çº¿ç¨‹æ›´æ–°UIå¯¼è‡´å´©æºƒ
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨@MainActorç¡®ä¿ä¸»çº¿ç¨‹æ›´æ–°
```swift
await MainActor.run {
    self.healthData = newData
}
```

### 14.3 AIè¯·æ±‚å¤±è´¥å¤„ç†

**éš¾ç‚¹**ï¼šç½‘ç»œä¸ç¨³å®šæˆ–APIé™æµ
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- é™çº§ç­–ç•¥ï¼šè¿”å›é¢„è®¾å›å¤
- é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½

### 14.4 é‡‘å¸è®¡ç®—æ—¶æœº

**éš¾ç‚¹**ï¼šé¿å…é‡å¤å¥–åŠ±é‡‘å¸
**è§£å†³æ–¹æ¡ˆ**ï¼š
- è®°å½•ä¸Šæ¬¡è®¡ç®—æ—¶é—´
- åªåœ¨æ—¥æœŸå˜æ›´æ—¶é‡æ–°è®¡ç®—
- UserDefaultsæŒä¹…åŒ–çŠ¶æ€

---

## 15. æµ‹è¯•ä¸è°ƒè¯•

### 15.1 è°ƒè¯•æ¨¡å¼

**å¼€å¯æ–¹å¼**ï¼šé•¿æŒ‰è®¾ç½®æŒ‰é’®2ç§’
**è°ƒè¯•åŠŸèƒ½**ï¼š
- æ‰‹åŠ¨ä¿®æ”¹æ‰€æœ‰å¥åº·æ•°æ®
- ä¸€é”®è§£é”æ‰€æœ‰è§’è‰²
- æ·»åŠ ä»»æ„æ•°é‡é‡‘å¸
- æ¸…ç©ºå¥åº·å†å²
- æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

### 15.2 æ¨¡æ‹Ÿæ•°æ®

```swift
// è°ƒè¯•é¢æ¿å¯è®¾ç½®æ¨¡æ‹Ÿæ•°æ®
æ­¥æ•°ï¼š0-50000
ç¡çœ ï¼š0-12å°æ—¶
è¿åŠ¨ï¼š0-180åˆ†é’Ÿ
å¿ƒç‡ï¼š40-200 bpm
```

### 15.3 é”™è¯¯å¤„ç†

**HealthKitæƒé™**ï¼šå¼•å¯¼ç”¨æˆ·åˆ°è®¾ç½®æˆæƒ
**ç½‘ç»œé”™è¯¯**ï¼šæ˜¾ç¤ºé‡è¯•æŒ‰é’®
**æ•°æ®å¼‚å¸¸**ï¼šä½¿ç”¨é»˜è®¤å€¼å¹¶è®°å½•æ—¥å¿—

---

## 16. æ€»ç»“ä¸å±•æœ›

### 16.1 é¡¹ç›®æ€»ç»“

**æŠ€æœ¯å®ç°**
- âœ… å®Œæ•´çš„MVVMæ¶æ„å®è·µ
- âœ… Combineå“åº”å¼ç¼–ç¨‹
- âœ… HealthKitæ·±åº¦é›†æˆ
- âœ… AIå¯¹è¯ç³»ç»Ÿ
- âœ… SwiftUIç°ä»£åŒ–UI

**åŠŸèƒ½å®Œæˆåº¦**
- âœ… å¥åº·æ•°æ®å®æ—¶è¿½è¸ª
- âœ… å¤šè§’è‰²ç³»ç»Ÿ
- âœ… é‡‘å¸å¥–åŠ±æœºåˆ¶
- âœ… æ™ºèƒ½å¯¹è¯
- âœ… å†å²æ•°æ®åˆ†æ

**ç”¨æˆ·ä½“éªŒ**
- âœ… æµç•…çš„åŠ¨ç”»æ•ˆæœ
- âœ… æ¸…æ™°çš„ä¿¡æ¯æ¶æ„
- âœ… æ¸¸æˆåŒ–æ¿€åŠ±æœºåˆ¶
- âœ… ä¸ªæ€§åŒ–äº¤äº’

### 16.2 æŠ€æœ¯æ”¶è·

**MVVMæ¶æ„ç†è§£**
- Modelã€Viewã€ViewModelèŒè´£æ¸…æ™°
- å•å‘æ•°æ®æµæ˜“äºç»´æŠ¤
- å“åº”å¼ç¼–ç¨‹æå‡å¼€å‘æ•ˆç‡

**SwiftUIæŒæ¡**
- å£°æ˜å¼UIå¼€å‘æ€ç»´
- çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ
- åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœ

**HealthKitåº”ç”¨**
- å¥åº·æ•°æ®è¯»å–å’Œå¤„ç†
- æƒé™ç®¡ç†æµç¨‹
- åå°æ•°æ®ç›‘å¬

**AIé›†æˆç»éªŒ**
- APIè°ƒç”¨å’Œé”™è¯¯å¤„ç†
- Promptå·¥ç¨‹å®è·µ
- å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼

### 16.3 æœªæ¥å±•æœ›

**åŠŸèƒ½æ‰©å±•**
1. **ç¤¾äº¤åŠŸèƒ½**
   - å¥½å‹ç³»ç»Ÿ
   - å¥åº·æŒ‘æˆ˜PK
   - æ’è¡Œæ¦œ

2. **æ›´å¤šè§’è‰²**
   - å¢åŠ è§’è‰²ç§ç±»
   - è‡ªå®šä¹‰è§’è‰²å¤–è§‚
   - è§’è‰²æŠ€èƒ½ç³»ç»Ÿ

3. **å¥åº·åˆ†æ**
   - æ›´è¯¦ç»†çš„å¥åº·æŠ¥å‘Š
   - ç–¾ç—…é£é™©é¢„è­¦
   - ä¸“ä¸šå¥åº·å»ºè®®

4. **æ¿€åŠ±æœºåˆ¶**
   - æˆå°±ç³»ç»Ÿ
   - æ¯æ—¥ä»»åŠ¡
   - ç­¾åˆ°å¥–åŠ±

**æŠ€æœ¯ä¼˜åŒ–**
1. **æ€§èƒ½æå‡**
   - å¼•å…¥Core Dataæ›¿ä»£UserDefaults
   - å›¾ç‰‡èµ„æºä¼˜åŒ–
   - å‡å°‘ä¸å¿…è¦çš„UIåˆ·æ–°

2. **æ¶æ„æ”¹è¿›**
   - å¼•å…¥Coordinatoræ¨¡å¼ç®¡ç†å¯¼èˆª
   - ä½¿ç”¨Repositoryæ¨¡å¼ç»Ÿä¸€æ•°æ®è®¿é—®
   - æ·»åŠ å•å…ƒæµ‹è¯•å’ŒUIæµ‹è¯•

3. **ç”¨æˆ·ä½“éªŒ**
   - æ”¯æŒæš—é»‘æ¨¡å¼
   - å¢åŠ æ— éšœç¢åŠŸèƒ½
   - å¤šè¯­è¨€å›½é™…åŒ–

### 16.4 è¯¾ç¨‹å­¦ä¹ æ„Ÿæ‚Ÿ

é€šè¿‡æœ¬é¡¹ç›®çš„å¼€å‘ï¼Œæ·±å…¥ç†è§£äº†ç§»åŠ¨åº”ç”¨å¼€å‘çš„å®Œæ•´æµç¨‹ï¼š

**æ¶æ„è®¾è®¡**ï¼šMVVMæ¶æ„è®©ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•

**å“åº”å¼ç¼–ç¨‹**ï¼šCombineå’Œ@Publishedè®©æ•°æ®æµåŠ¨å˜å¾—ç®€å•ç›´è§‚

**UIå¼€å‘**ï¼šSwiftUIçš„å£°æ˜å¼è¯­æ³•å¤§å¹…æå‡å¼€å‘æ•ˆç‡

**ç³»ç»Ÿé›†æˆ**ï¼šHealthKitç­‰ç³»ç»Ÿæ¡†æ¶çš„ä½¿ç”¨æ‰©å±•äº†åº”ç”¨èƒ½åŠ›

**AIåº”ç”¨**ï¼šå°†AIæŠ€æœ¯èå…¥ç§»åŠ¨åº”ç”¨ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

è¿™ä¸ªé¡¹ç›®ä¸ä»…æ˜¯ä¸€æ¬¡æŠ€æœ¯å®è·µï¼Œæ›´æ˜¯å¯¹ç§»åŠ¨åº”ç”¨å¼€å‘ç†å¿µçš„å…¨é¢å­¦ä¹ å’Œåº”ç”¨ã€‚

---

## é™„å½•

### A. é¡¹ç›®è¿è¡Œç¯å¢ƒ

- iOS 17.0+
- Xcode 15.0+
- Swift 5.9+
- macOS 14.0+ (å¼€å‘ç¯å¢ƒ)

### B. ç¬¬ä¸‰æ–¹ä¾èµ–

æœ¬é¡¹ç›®æ— ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå…¨éƒ¨ä½¿ç”¨Appleå®˜æ–¹æ¡†æ¶ï¼š
- SwiftUI
- Combine
- HealthKit
- Foundation
- URLSession

### C. å‚è€ƒèµ„æ–™

- [Apple SwiftUI Documentation](https://developer.apple.com/documentation/swiftui)
- [Apple HealthKit Framework](https://developer.apple.com/documentation/healthkit)
- [Combine Framework Guide](https://developer.apple.com/documentation/combine)
- [MVVM Design Pattern](https://en.wikipedia.org/wiki/Modelâ€“viewâ€“viewmodel)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0  
**æœ€åæ›´æ–°**ï¼š2025å¹´12æœˆ27æ—¥  
**é¡¹ç›®åç§°**ï¼šVitalityPactï¼ˆæ´»åŠ›å¥‘çº¦ï¼‰  
**å¼€å‘è€…**ï¼šHenry King  
**è¯¾ç¨‹**ï¼šç§»åŠ¨åº”ç”¨å¼€å‘

---

*æœ¬æ–‡æ¡£ä¸ºè¯¾ç¨‹ç­”è¾©ä¸“ç”¨æŠ€æœ¯æ–‡æ¡£ï¼Œè¯¦ç»†é˜è¿°äº†é¡¹ç›®çš„MVVMæ¶æ„è®¾è®¡ä¸å®ç°ç»†èŠ‚ã€‚*

